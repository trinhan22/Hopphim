<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HopPhim - Phim Hay Trong Tầm Tay</title>
    
    <meta property="og:title" content="HopPhim" />
    <meta property="og:image" content="https://hopphim.netlify.app/panel.webp" />
    
    <link rel="icon" type="image/webp" href="/LOGO.WEBP" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ==========================================================================
           1. CSS CORE & VARIABLES (DESIGN SYSTEM)
           ========================================================================== 
        */
        :root {
            --bg-body: #191b24; 
            --bg-dark: #0f111a; 
            --bg-panel: #23252f; 
            --text-main: #ffffff; 
            --text-sub: #a0a0a0;
            --gradient-main: linear-gradient(90deg, #FF8F50, #FF5E62); 
            --primary-color: #FF5E62;
            --gold-color: linear-gradient(90deg, #FF8F50, #FF5E62);
            --font-main: 'Inter', sans-serif; 
            --card-radius: 12px;
            --mobile-menu-bg: #15171e; 
            --mobile-border: rgba(255,255,255,0.05);
            --transition-smooth: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            --z-header: 5000;
            --z-modal: 10000;
            --z-hover-detail: 99999;
        }

        /* Basic Resets */
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            outline: none; 
            -webkit-tap-highlight-color: transparent; 
        }

        body { 
            font-family: var(--font-main); 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            overflow-x: hidden; 
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        a { text-decoration: none; color: inherit; transition: var(--transition-smooth); }
        ul { list-style: none; }
        button { border: none; cursor: pointer; font-family: var(--font-main); }

        /* Custom Scroller cho toàn trang */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-color); }

        /* ==========================================================================
           2. UTILITY CLASSES & KEYFRAMES
           ========================================================================== 
        */
        .text-gradient { 
            background: var(--gradient-main); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            display: inline-block; 
            font-weight: 800;
        }

        .flex-center { display: flex; align-items: center; justify-content: center; }
        .flex-between { display: flex; align-items: center; justify-content: space-between; }

        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(1.1); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes floatIdle { 0% { transform: scale(1); } 50% { transform: scale(0.9); } 100% { transform: scale(1); } }

        /* --- TOAST & CONFIRM (Giữ nguyên) --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: #23252f; color: #fff; padding: 15px 25px; border-radius: 12px; display: flex; align-items: center; gap: 12px; min-width: 300px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border-left: 4px solid var(--primary-color); animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1); pointer-events: auto; }
        .toast.success { border-left-color: #2ecc71; } .toast.error { border-left-color: #ff4757; } .toast i { font-size: 1.2rem; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .custom-confirm-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 10001; display: none; justify-content: center; align-items: center; opacity: 0; transition: 0.3s; backdrop-filter: blur(5px); }
        .custom-confirm-overlay.active { display: flex; opacity: 1; }
        .confirm-box { background: #1f222e; width: 90%; max-width: 400px; padding: 30px; border-radius: 16px; text-align: center; border: 1px solid rgba(255,255,255,0.1); transform: scale(0.9); transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .custom-confirm-overlay.active .confirm-box { transform: scale(1); }
        .confirm-icon { font-size: 3rem; margin-bottom: 15px; background: var(--gradient-main); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .confirm-title { font-size: 1.2rem; font-weight: 700; color: #fff; margin-bottom: 10px; }
        .confirm-desc { font-size: 0.95rem; color: var(--text-sub); margin-bottom: 25px; line-height: 1.5; }
        .confirm-actions { display: flex; gap: 15px; justify-content: center; }
        .btn-confirm { padding: 10px 25px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; transition: 0.2s; font-size: 0.95rem; }
        .btn-cancel { background: transparent; color: #ccc; border: 1px solid rgba(255,255,255,0.2); } .btn-cancel:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-ok { background: var(--gradient-main); color: #fff; box-shadow: 0 4px 15px rgba(255, 94, 98, 0.3); } .btn-ok:hover { transform: translateY(-2px); }

        /* --- LOADING SCREEN --- */
        #loadingScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: var(--bg-body); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .loading-img { width: 800px; max-width: 80vw; height: auto; object-fit: contain; animation: zoomIn 0.8s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards, floatIdle 4s ease-in-out infinite 0.8s; }
        .loading-img.zoom-out { animation: zoomOut 0.5s cubic-bezier(0.6, -0.28, 0.74, 0.05) forwards !important; }
        @media (max-width: 900px) { .loading-img { width: 500px; } }
        @keyframes zoomIn { 0% { transform: scale(1.1); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes floatIdle { 0% { transform: scale(1); } 50% { transform: scale(0.85); } 100% { transform: scale(1); } }
        @keyframes zoomOut { from { transform: scale(1); opacity: 1; } to { transform: scale(2.2); opacity: 0; } }

        /* ==========================================================================
           5. HEADER (MOBILE REMASTER: BURGER-LOGO-SEARCH)
           ========================================================================== 
        /* ======================== HEADER PC (MENU MỚI) ======================== */
        header { 
            position: fixed; top: 0; width: 100%; height: 70px; padding: 0 4%; 
            display: flex; justify-content: space-between; align-items: center; 
            z-index: 1000; background: transparent; transition: all 0.3s ease-in-out; 
        }
        header.scrolled { background: var(--bg-dark); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4); }
        
        .header-left-group { display: flex; align-items: center; gap: 30px; height: 100%; }
        .logo { display: flex; align-items: center; gap: 10px; cursor: pointer; z-index: 1002; }
        .logo img { height: 40px; object-fit: contain; }
        .logo-text { font-size: 1.5rem; font-weight: 900; letter-spacing: 1px; text-transform: uppercase; background: var(--gradient-main); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        
        /* Nav Links */
        .nav-links { display: flex; gap: 15px; list-style: none; height: 100%; align-items: center; }
        
        /* Item của Menu */
        .nav-item { 
            position: relative; height: 100%; display: flex; align-items: center; 
            padding: 0 10px; cursor: pointer;
        }
        
        .nav-link { 
            color: #ccc; text-decoration: none; font-size: 14px; font-weight: 600; 
            text-transform: uppercase; transition: 0.3s; white-space: nowrap; 
            display: flex; align-items: center; gap: 5px;
        }
        .nav-item:hover .nav-link { color: #fff; }
        .nav-link i { font-size: 0.8rem; margin-top: -2px; }

        /* DROPDOWN MENU (BẢNG XỔ XUỐNG) */
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 70px; /* Bằng chiều cao header */
            left: 0;
            background: rgba(15, 17, 26, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-top: 2px solid var(--primary-color);
            padding: 20px;
            border-radius: 0 0 12px 12px;
            width: 500px; /* Chiều rộng bảng */
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            transform-origin: top left;
            animation: fadeIn 0.2s ease-out;
        }

        .dropdown-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4 Cột */
            gap: 12px;
        }

        .dropdown-item-link {
            color: #a0a0a0; text-decoration: none; font-size: 0.9rem; transition: 0.2s;
            padding: 5px 8px; border-radius: 6px;
        }
        .dropdown-item-link:hover {
            color: #fff; background: rgba(255,255,255,0.1);
        }

        /* Hover vào Nav Item thì hiện Dropdown */
        .nav-item:hover .dropdown-menu { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Right Elements */
        .right-elements { display: flex; align-items: center; gap: 15px; }
        .search-box { display: flex; align-items: center; background: #23252f; padding: 8px 16px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.05); }
        .search-box input { background: transparent; border: none; color: #fff; margin-left: 10px; font-family: var(--font-main); font-size: 14px; width: 150px; }
        .menu-toggle, .mobile-search-trigger { display: none; font-size: 1.5rem; color: #fff; cursor: pointer; }
        .btn-login { background: var(--gradient-main); color: #fff; border: none; padding: 8px 20px; border-radius: 50px; font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: 0.3s; white-space: nowrap; }
        .btn-login:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(255, 94, 98, 0.4); }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary-color); cursor: pointer; display: none; object-fit: cover; }
        .user-dropdown { position: absolute; top: 100%; right: 0; width: 200px; margin-top: 15px; background: #23252f; border-radius: 8px; padding: 5px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: none; flex-direction: column; border: 1px solid rgba(255,255,255,0.1); }
        .user-dropdown.active { display: flex; }
        .user-info-item { padding: 12px; color: #fff; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .dropdown-item { background: transparent; border: none; color: #ccc; text-align: left; padding: 10px; cursor: pointer; transition: 0.2s; border-radius: 4px; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; }
        .dropdown-item:hover { background: rgba(255,255,255,0.1); color: #fff; }


        /* --- MOBILE HEADER REMASTER (3-PART ARCHITECTURE) --- */
        @media (max-width: 900px) {
            header { height: 60px; padding: 0 15px; display: flex; justify-content: center; align-items: center; position: fixed; }
            .header-left-group, .nav-links, .search-box, .desktop-auth { display: none !important; }
            
            /* Hamburger Trái Tuyệt Đối */
            .menu-toggle { 
                display: block !important; position: absolute; left: 15px; 
                font-size: 1.5rem; color: #fff; cursor: pointer; z-index: 5005;
            }
            /* Logo Giữa Tuyệt Đối */
            .logo { 
                position: absolute; left: 50%; top: 50%; 
                transform: translate(-50%, -50%); margin: 0; 
                display: flex !important; z-index: 5000;
            }
            .logo img { height: 32px; }
            .logo-text { font-size: 1.1rem; }
            /* Search Phải Tuyệt Đối */
            .mobile-search-trigger { 
                display: block !important; position: absolute; right: 15px; 
                font-size: 1.3rem; color: #fff; cursor: pointer; z-index: 5005;
            }
        }

        /* ==========================================================================
           6. HERO & TOPICS (COMPACT)
           ========================================================================== 
        */
        .hero { 
            height: 70vh; display: flex; align-items: center; justify-content: center; 
            position: relative; background: url('home-background.jpg') center/cover no-repeat;
        }
        .hero::before { content: ''; position: absolute; inset: 0; background: rgba(0,0,0,0.3); }
        .hero::after { 
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 250px; 
            background: linear-gradient(to bottom, transparent, var(--bg-body)); 
        }
        .hero-content { position: relative; z-index: 10; text-align: center; max-width: 900px; padding: 20px; }
        .hero-title { font-size: 4.5rem; font-weight: 900; line-height: 1.1; letter-spacing: -3px; }
        .hero-desc { font-size: 1.25rem; color: #eee; font-weight: 600; margin-top: 15px; }

        .topics-section { padding: 0 4%; margin-top: -60px; position: relative; z-index: 20; margin-bottom: 60px; }
        .section-label { font-size: 1.3rem; font-weight: 800; margin-bottom: 25px; color: #fff; letter-spacing: -0.5px; }

        .topic-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 20px; }

        .topic-card { 
            height: 115px; border-radius: 20px; padding: 22px; 
            display: flex; flex-direction: column; justify-content: space-between; 
            cursor: pointer; position: relative; overflow: hidden; 
            transition: var(--transition-smooth);
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
        }

        .topic-card:hover {
            transform: translateY(-10px);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }

        /* Decorative Blur Elements behind card */
        .topic-card::before {
            content: ''; position: absolute; top: 50%; left: 50%;
            width: 120px; height: 120px; border-radius: 50%;
            transform: translate(-50%, -50%);
            filter: blur(35px); opacity: 0.4; z-index: 1;
            transition: 0.6s ease;
        }

        .topic-card:hover::before { width: 160px; height: 160px; opacity: 0.7; }

        /* Icon mờ đặc trưng */
        .topic-card i.floating-icon {
            position: absolute; bottom: -10px; right: -5px;
            font-size: 4rem; color: rgba(255, 255, 255, 0.05);
            transform: rotate(-15deg); transition: 0.5s; z-index: 1;
        }
        .topic-card:hover i.floating-icon { color: rgba(255, 255, 255, 0.1); transform: rotate(0deg) scale(1.1); }

        .topic-name { font-size: 1.3rem; font-weight: 900; z-index: 2; position: relative; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .topic-link { font-size: 0.8rem; font-weight: 800; display: flex; align-items: center; gap: 6px; z-index: 2; position: relative; color: rgba(255,255,255,0.7); }
        .topic-card:hover .topic-link { color: #fff; }

        /* Beautiful Color Palettes */
        .bg-marvel::before { background: #ed1d24; }
        .bg-sitcom::before { background: #00d2ff; }
        .bg-voice::before { background: #a8ff78; }
        .bg-trans::before { background: #8e44ad; }
        .bg-ancient::before { background: #f1c40f; }
        .bg-4k::before { background: #ffffff; }

        /* ==========================================================================
           7. MERGED COUNTRY BLOCK (KỸ THUẬT NỔI HOÀN TOÀN - PORTAL STYLE)
           ========================================================================== 
        */
.merged-block { 
    background: var(--bg-panel); 
    border-radius: 16px; 
    margin: 0 4% 40px; 
    padding: 20px 25px !important; /* Thu nhỏ padding khối lớn */
    border: 1px solid rgba(255,255,255,0.05); 
    box-shadow: 0 15px 50px rgba(0,0,0,0.2);
    overflow: visible !important; 
    isolation: isolate; 
}

.country-section { 
    margin-bottom: 20px; 
    position: relative; 
    overflow: visible !important; 
}
        .country-section:last-child { margin-bottom: 0; }
        .country-section:not(:last-child) { border-bottom: 1px solid rgba(255,255,255,0.04); padding-bottom: 20px; }

.country-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: flex-end; 
    margin-bottom: 20px; 
}
.ch-title { font-size: 1.6rem !important; font-weight: 900; }
        .ch-link { font-size: 0.9rem; color: var(--text-sub); display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 700; }
        .ch-link:hover { color: #fff; }

        .grid-wrapper { position: relative; width: 100%; overflow: visible !important; }
        
        .nav-arrow {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 45px; height: 45px; background: rgba(0,0,0,0.85);
            border: 1px solid rgba(255,255,255,0.1); color: #fff;
            border-radius: 50%; cursor: pointer; z-index: 1002;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: var(--transition-smooth); backdrop-filter: blur(5px);
        }
        .grid-wrapper:hover .nav-arrow { opacity: 1; }
        .arrow-prev { left: -22px; }
        .arrow-next { right: -22px; }

        /* FIXED: Padding-Compensation để bung lụa ra ngoài container */
.country-grid { 
    display: flex; 
    flex-wrap: nowrap; 
    gap: 20px; 
    overflow-x: auto !important; 
    scroll-behavior: smooth; 
    scrollbar-width: none;
    /* Tạo vùng đệm 100px để Card Detail thoải mái "lú" ra */
    padding: 100px 0 !important; 
    margin: -100px 0 !important; 
}
.country-grid::-webkit-scrollbar { display: none; }

        /* Card System (PC: 4 Phim/Hàng) */
.n-card {
    flex: 0 0 calc(25% - 15px);
    position: relative; 
    aspect-ratio: 16/9; 
    border-radius: 10px; 
    cursor: pointer;
    transition: transform 0.4s ease; 
    background: #1a1c24;
    z-index: 10;
}
.n-poster { 
    width: 100%; height: 100%; 
    object-fit: cover; 
    border-radius: 10px; 
    display: block; 
}
        
        /* ======================== 
           REFINED MICRO HOVER DETAIL 
           ======================== */
.n-hover-detail {
    position: absolute; 
    top: -55%; /* Căn giữa card detail so với card gốc */
    left: -3%; 
    width: 106%; /* FIXED: Thu nhỏ chiều rộng tối đa */
    
    /* Hiệu ứng Kính lỏng cao cấp */
    background: rgba(20, 21, 26, 0.8) !important;
    backdrop-filter: blur(25px) saturate(180%) !important;
    -webkit-backdrop-filter: blur(25px) saturate(180%) !important;
    
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.15) !important;
    box-shadow: 0 40px 100px rgba(0,0,0,1);
    
    opacity: 0; 
    visibility: hidden; 
    pointer-events: none;
    transform: scale(0.9); 
    transition: all 0.4s cubic-bezier(0.33, 1, 0.68, 1);
    z-index: 99999 !important; /* Luôn trên cùng */
    overflow: hidden;
}
.n-hover-detail::before {
    content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
    background: radial-gradient(circle, rgba(255, 94, 98, 0.12) 0%, transparent 70%);
    animation: rotateBlur 12s linear infinite;
    z-index: -1;
}
.n-card:hover { z-index: 99998; }
.n-card:hover .n-hover-detail { 
    opacity: 1; 
    visibility: visible; 
    transform: scale(1.03); /* Phóng to rất nhẹ nhàng */
    pointer-events: auto;
}
        .c-info { padding: 10px; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); position: absolute; bottom: 0; left: 0; width: 100%; border-radius: 0 0 10px 10px; }
        .n-card:hover .c-info { opacity: 0; }
        .c-title { font-weight: 800; font-size: 0.9rem; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .n-hover-img { width: 100%; aspect-ratio: 16/9; object-fit: cover; }
.n-popup-body { 
    padding: 12px 15px !important; /* Thu nhỏ không gian bên trong */
    background: linear-gradient(to bottom, transparent, rgba(15, 17, 26, 0.8));
}
.n-actions { display: flex; gap: 8px; margin-bottom: 10px; }     
        /* FIXED: Micro Buttons */
.btn-play-now {
    flex: 1; 
    background: var(--gradient-main); 
    color: #fff; 
    padding: 6px !important; 
    border-radius: 6px;
    font-weight: 800; 
    font-size: 0.75rem !important; /* Chữ siêu nhỏ gọn */
    display: flex; align-items: center; justify-content: center; gap: 5px;
}
.btn-icon-round {
    width: 28px !important; 
    height: 28px !important; 
    border-radius: 50%; 
    border: 1.5px solid rgba(255,255,255,0.2) !important;
    background: rgba(255,255,255,0.05);
    font-size: 0.8rem !important;
}
        
        /* FIXED: Compact Typography */
.n-title { 
    font-weight: 900; 
    font-size: 0.95rem !important; /* Tiêu đề nhỏ lại */
    margin-bottom: 4px; 
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.n-desc { 
    font-size: 0.7rem !important; /* Mô tả nhỏ và mờ tinh tế */
    color: rgba(255, 255, 255, 0.5) !important;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; 
    overflow: hidden; line-height: 1.4; 
}
.n-meta-row { 
    display: flex; align-items: center; gap: 10px; 
    font-size: 0.7rem !important; /* Meta row nhỏ lại */
    color: #46d369; font-weight: 800; margin-bottom: 10px; 
}
.badge-hd { 
    border: 1px solid #555; padding: 0px 4px; border-radius: 2px; 
    color: #fff; font-size: 0.55rem !important; 
}

        /* ==========================================================================
           8. TOP 5 TRENDING (BALANCED SIZE)
           ========================================================================== 
        */
        .top-10-wrapper { position: relative; z-index: 20; padding: 0 4% 80px; }
        .top-10-header { display: flex; align-items: center; gap: 18px; margin-bottom: 40px; }
        .top-10-header h2 { font-size: 2.5rem; font-weight: 900; font-style: italic; letter-spacing: -1px; }
        .top-5-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; }

        .top-card-style2 { position: relative; cursor: pointer; transition: 0.4s ease; width: 100%; }
        .top-card-style2:hover { transform: translateY(-12px); }
        .top-poster-style2 { 
            width: 100%; aspect-ratio: 2/3; border-radius: 15px; overflow: hidden; position: relative; 
            box-shadow: 0 12px 40px rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.06); 
        }
        .top-poster-style2 img { width: 100%; height: 100%; object-fit: cover; }
        
        .top-info-row { display: flex; align-items: flex-start; margin-top: 22px; }
        
        /* Rank numbers: THU NHỎ LẠI THEO YÊU CẦU */
.top-rank-style2 { 
    font-size: 3.5rem !important; /* Thu nhỏ con số rank */
    line-height: 0.8; 
    font-family: 'Impact', sans-serif; 
    font-style: italic; 
    font-weight: 900; 
    color: #eebb5d; 
    margin-right: 12px; 
    text-shadow: 2px 2px 0px #000; 
    flex-shrink: 0; 
}
        .top-text-style2 { flex: 1; padding-top: 5px; }
        .top-title-style2 { font-size: 1.05rem; font-weight: 800; color: #fff; margin-bottom: 5px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3; }
        .top-meta-style2 { font-size: 0.85rem; color: #666; font-weight: 600; }

        /* ==========================================================================
           9. MODAL (PC: FIXED 5 GRID)
           ========================================================================== 
        */
        .modal { 
            display: none; position: fixed; inset: 0; z-index: var(--z-modal); 
            background: rgba(10, 11, 16, 0.98); padding: 80px 4%; overflow-y: auto; 
            backdrop-filter: blur(20px); 
        }
        .modal.active { display: block; animation: fadeIn 0.4s ease; }
        .modal-grid { 
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 25px; 
            max-width: 1300px; margin: 0 auto; padding-bottom: 50px;
        }
        .modal-card { 
            border-radius: 12px; overflow: hidden; background: #23252f; 
            transition: 0.3s; cursor: pointer; aspect-ratio: 2/3; position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .modal-card img { width: 100%; height: 100%; object-fit: cover; }
        .card-info-modal { position: absolute; bottom: 0; left: 0; width: 100%; padding: 15px; background: linear-gradient(to top, #000, transparent); }

        /* ==========================================================================
           10. FOOTER (MOBILE REMASTER: CENTERED ALL)
           ========================================================================== 
        */
        footer { background: var(--bg-dark); padding: 60px 4% 20px; margin-top: 80px; border-top: 1px solid #23252f; font-size: 0.9rem; }
        .footer-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 40px; margin-bottom: 40px; }
        .footer-col h3 { font-size: 1.1rem; color: #fff; margin-bottom: 20px; font-weight: 700; }
        .footer-brand { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .footer-brand img { height: 50px; object-fit: contain; }
        .footer-col ul { list-style: none; } .footer-col ul li { margin-bottom: 12px; }
        .footer-col ul li a { color: var(--text-sub); text-decoration: none; transition: 0.3s; } .footer-col ul li a:hover { color: var(--primary-color); padding-left: 5px; }
        .footer-bottom { border-top: 1px solid #23252f; padding-top: 20px; display: flex; justify-content: space-between; align-items: center; color: #64748b; font-size: 0.8rem; }

@media (max-width: 900px) {
    footer .footer-grid { 
        grid-template-columns: 1fr !important; 
        text-align: center !important; 
        gap: 30px; 
    }
    footer .footer-col ul { display: flex; flex-direction: column; align-items: center; }
    footer .footer-brand { justify-content: center; }


            .hero-title { font-size: 2.8rem; }
            .topic-grid { display: flex; overflow-x: auto; scrollbar-width: none; gap: 12px; padding-bottom: 10px; }
            .topic-card { flex: 0 0 150px; height: 90px; }
            
            .merged-block { padding: 25px 15px; border-radius: 0; margin: 0 0 40px; border: none; }
            .country-grid { gap: 12px; padding: 10px 0; margin: -10px 0; }
            .n-card { flex: 0 0 240px; }
            .nav-arrow { display: none; } 
            
            .top-rank-style2 { font-size: 3rem; }
            .modal-grid { grid-template-columns: repeat(2, 1fr); gap: 15px; }
        }

        /* ==========================================================================
           11. MOBILE MENU DRAWER
           ========================================================================== 
        */
        .mobile-overlay { position: fixed; inset: 0; z-index: 10000; transition: 0.5s cubic-bezier(0.77, 0, 0.175, 1); }
        #mobileMenuOverlay { background: var(--mobile-menu-bg); transform: translateX(-100%); padding: 30px; width: 310px; box-shadow: 20px 0 60px rgba(0,0,0,0.8); }
        #mobileMenuOverlay.active { transform: translateX(0); }
        
        .menu-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .menu-logo { display: flex; align-items: center; gap: 10px; font-size: 1.3rem; font-weight: 900; }
        
        .member-btn-large { 
            width: 100%; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 12px; 
            border: 1px solid rgba(255,255,255,0.08); color: #fff; font-weight: 800; 
            display: flex; align-items: center; gap: 12px; margin-bottom: 30px; cursor: pointer; font-size: 0.95rem;
        }

        .mobile-menu-link { padding: 16px 0; font-size: 1rem; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.03); display: flex; align-items: center; gap: 15px; color: #999; }
        .mobile-menu-link i { color: var(--primary-color); width: 22px; text-align: center; }

        #mobileSearchOverlay { background: #0f111a; transform: translateY(-100%); opacity: 0; padding: 15px; transition: 0.4s; }
        #mobileSearchOverlay.active { transform: translateY(0); opacity: 1; }
        .search-header-mobile { display: flex; align-items: center; background: #23252f; padding: 12px 18px; border-radius: 12px; }
        .search-input-mobile { flex: 1; background: transparent; border: none; color: #fff; font-size: 1rem; margin-left: 10px; }

        @media (max-width: 900px) {
            /* Ép khung Top 5 thành hàng ngang và cho phép trượt */
            .top-5-grid {
                display: flex !important; /* Chuyển từ Grid sang Flex để nằm trên 1 hàng */
                flex-wrap: nowrap !important; 
                overflow-x: auto !important; 
                gap: 15px;
                padding-bottom: 20px;
                scrollbar-width: none; /* Ẩn scrollbar cho Firefox */
                -webkit-overflow-scrolling: touch; /* Trượt mượt hơn trên iPhone */
            }

            /* Ẩn thanh cuộn cho Chrome/Safari */
            .top-5-grid::-webkit-scrollbar { 
                display: none; 
            }

            /* Định hình kích thước từng Card để nó lú ra ngoài và trượt được */
            .top-card-style2 {
                flex: 0 0 150px; /* Cố định độ rộng mỗi card là 150px, không cho nó co lại */
            }

            /* Thu nhỏ con số rank một chút cho cân đối trên mobile */
            .top-rank-style2 {
                font-size: 3rem !important;
                margin-right: 8px !important;
            }
        }
    </style>
</head>
<body>

    <div id="loadingScreen">
        <img src="/Loading.png" class="loading-img" alt="HopPhim">
    </div>

    <div id="toast-container"></div>

    <div id="confirmModal" class="custom-confirm-overlay">
        <div class="confirm-box">
            <div class="confirm-icon"><i class="fas fa-question-circle"></i></div>
            <h3 style="color:#fff; font-size:1.5rem; margin-bottom:10px;">Xác nhận</h3>
            <p id="confirmMsg" style="color:#888; font-size:1rem;">Bạn có chắc chắn muốn thực hiện hành động này?</p>
            <div class="confirm-actions" style="margin-top:25px;">
                <button class="btn-confirm btn-cancel" id="btnConfirmNo">Hủy bỏ</button>
                <button class="btn-confirm btn-ok" id="btnConfirmYes">Đồng ý</button>
            </div>
        </div>
    </div>

    <div id="mobileMenuOverlay" class="mobile-overlay">
        <div class="menu-header">
            <div class="menu-logo"><img src="/LOGO.WEBP" style="height:35px;"><span class="logo-text text-gradient">HOPPHIM</span></div>
            <i class="fas fa-times" onclick="closeMobileMenu()" style="font-size:1.6rem; color:#fff; cursor:pointer;"></i>
        </div>
        <button class="member-btn-large" id="mobileMemberBtn" onclick="window.location.href='/login.html'">
            <i class="fas fa-user-circle" style="font-size:1.6rem; color:var(--primary-color)"></i> 
            <span id="mobileMemberText">Đăng nhập / Đăng ký</span>
        </button>
        <div class="mobile-menu-list">
            <a href="/" class="mobile-menu-link" onclick="closeMobileMenu()"><i class="fas fa-home"></i> Trang chủ</a>
            <a href="#" class="mobile-menu-link" onclick="closeMobileMenu(); loadCategory('phim-moi', 'Phim Mới')"><i class="fas fa-bolt"></i> Phim Mới</a>
            <a href="#" class="mobile-menu-link" onclick="closeMobileMenu(); loadCategory('phim-bo', 'Phim Bộ')"><i class="fas fa-tv"></i> Phim Bộ</a>
            <a href="#" class="mobile-menu-link" onclick="closeMobileMenu(); loadCategory('phim-le', 'Phim Lẻ')"><i class="fas fa-film"></i> Phim Lẻ</a>
            <div style="margin:20px 0 8px; color:#444; font-size:0.75rem; font-weight:900; text-transform:uppercase; letter-spacing:1px;">Quản Lý Tài Khoản</div>
            <a href="/hopteam" class="mobile-menu-link" onclick="closeMobileMenu()"><i class="fas fa-users"></i> Về HopTeam</a>
            <div id="mobileLogoutBtn" style="display:none;" class="mobile-menu-link" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Đăng xuất</div>
        </div>
    </div>

    <div id="mobileSearchOverlay" class="mobile-overlay">
        <div class="search-header-mobile">
            <i class="fas fa-search" style="color: #666;"></i>
            <input type="text" id="mobileSearchInput" class="search-input-mobile" placeholder="Tìm phim, diễn viên...">
            <i class="fas fa-times" onclick="closeMobileSearch()" style="color:#fff; cursor:pointer; margin-left: 12px;"></i>
        </div>
        <div id="mobileSearchResults" style="margin-top:20px;"></div>
    </div>

    <header id="siteHeader">
        <i class="fas fa-bars menu-toggle" style="display:none;" onclick="openMobileMenu()"></i>
        
        <div class="header-left-group">
            <div class="logo" onclick="loadHome()">
                <img src="/LOGO.WEBP" alt="Logo"><span class="logo-text text-gradient">HOPPHIM</span>
            </div>
            <ul class="nav-links" id="navLinks">
                <li class="nav-item">
                    <a href="/" class="nav-link" onclick="loadHome()">Trang chủ</a>
                </li>
                
                <li class="nav-item">
                    <div class="nav-link">Thể loại <i class="fas fa-caret-down"></i></div>
                    <div class="dropdown-menu">
                        <div class="dropdown-grid">
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('hanh-dong', 'Hành Động')">Hành Động</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('tinh-cam', 'Tình Cảm')">Tình Cảm</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('hai-huoc', 'Hài Hước')">Hài Hước</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('co-trang', 'Cổ Trang')">Cổ Trang</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('tam-ly', 'Tâm Lý')">Tâm Lý</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('hinh-su', 'Hình Sự')">Hình Sự</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('chien-tranh', 'Chiến Tranh')">Chiến Tranh</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('the-thao', 'Thể Thao')">Thể Thao</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('vo-thuat', 'Võ Thuật')">Võ Thuật</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('vien-tuong', 'Viễn Tưởng')">Viễn Tưởng</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('phieu-luu', 'Phiêu Lưu')">Phiêu Lưu</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('khoa-hoc', 'Khoa Học')">Khoa Học</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('kinh-di', 'Kinh Dị')">Kinh Dị</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('am-nhac', 'Âm Nhạc')">Âm Nhạc</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('than-thoai', 'Thần Thoại')">Thần Thoại</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('tai-lieu', 'Tài Liệu')">Tài Liệu</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('gia-dinh', 'Gia Đình')">Gia Đình</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('hoc-duong', 'Học Đường')">Học Đường</a>
                        </div>
                    </div>
                </li>

                <li class="nav-item"><a href="#" class="nav-link" onclick="loadCategory('phim-le', 'Phim Lẻ')">Phim Lẻ</a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="loadCategory('phim-bo', 'Phim Bộ')">Phim Bộ</a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="loadCategory('hoat-hinh', 'Hoạt Hình')">Hoạt Hình</a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="loadCategory('tv-shows', 'TV Shows')">TV Shows</a></li>

                <li class="nav-item">
                    <div class="nav-link">Quốc gia <i class="fas fa-caret-down"></i></div>
                    <div class="dropdown-menu" style="width: 400px;"> <div class="dropdown-grid" style="grid-template-columns: repeat(3, 1fr);">
                            <a href="#" class="dropdown-item-link" onclick="loadCountry('trung-quoc', 'Trung Quốc')">Trung Quốc</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCountry('han-quoc', 'Hàn Quốc')">Hàn Quốc</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCountry('nhat-ban', 'Nhật Bản')">Nhật Bản</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCountry('thai-lan', 'Thái Lan')">Thái Lan</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCountry('au-my', 'Âu Mỹ')">Âu Mỹ</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCountry('dai-loan', 'Đài Loan')">Đài Loan</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCountry('hong-kong', 'Hồng Kông')">Hồng Kông</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCountry('an-do', 'Ấn Độ')">Ấn Độ</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCountry('viet-nam', 'Việt Nam')">Việt Nam</a>
                        </div>
                    </div>
                </li>

                <li class="nav-item"><a class='nav-link' href='/hopteam'>Về HopTeam</a></li>
            </ul>
        </div>
        
        <div class="right-elements">
            <div class="mobile-search-trigger" style="display:none;" onclick="openMobileSearch()"><i class="fas fa-search"></i></div>
            
            <div class="search-box">
                <i class="fas fa-search" style="color: #666"></i>
                <input type="text" id="searchInput" placeholder="Tìm kiếm phim...">
            </div>

            <div class="desktop-auth" style="position: relative;">
                <button id="btnLogin" class="btn-login" onclick="window.location.href='/login.html'">Đăng nhập</button>
                <img id="userAvatar" class="user-avatar" src="" alt="User" onclick="toggleUserDropdown()">
                <div id="userMenu" class="user-dropdown">
                    <div id="userNameDisplay" class="user-info-item">Tài khoản</div>
                    <button class="dropdown-item" onclick="window.location.href='/profile.html'"><i class="fas fa-user-circle"></i> Trang cá nhân</button>
                    <button class="dropdown-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Đăng xuất</button>
                </div>
            </div>
        </div>
    </header>

    <section class="hero">
        <div class="hero-content">
            <h1 class="hero-title"><span class="text-gradient">HopPhim - Phim Hay<br>Trong Tầm Tay</span></h1>
            <p class="hero-desc">Xem phim chuẩn 4K Vietsub, cập nhật liên tục mỗi giờ tại HopPhim.</p>
        </div>
    </section>

    <div class="topics-section">
        <div class="section-label">Gợi ý cho bạn</div>
        <div class="topic-grid">
            <div class="topic-card bg-marvel" onclick="loadCategory('hanh-dong', 'Marvel Studios')"><div class="topic-name">Marvel</div><div class="topic-link">Xem ngay <i class="fas fa-arrow-right"></i></div></div>
            <div class="topic-card bg-sitcom" onclick="loadCategory('hai-huoc', 'Sitcom Hài Hước')"><div class="topic-name">Sitcom</div><div class="topic-link">Xem ngay <i class="fas fa-arrow-right"></i></div></div>
            <div class="topic-card bg-voice" onclick="loadCategory('hoat-hinh', 'Anime Nhật Bản')"><div class="topic-name">Anime</div><div class="topic-link">Xem ngay <i class="fas fa-arrow-right"></i></div></div>
            <div class="topic-card bg-trans" onclick="loadCategory('vien-tuong', 'Viễn Tưởng')"><div class="topic-name">Viễn Tưởng</div><div class="topic-link">Xem ngay <i class="fas fa-arrow-right"></i></div></div>
            <div class="topic-card bg-ancient" onclick="loadCategory('co-trang', 'Cổ Trang')"><div class="topic-name">Cổ Trang</div><div class="topic-link">Xem ngay <i class="fas fa-arrow-right"></i></div></div>
            <div class="topic-card bg-4k" onclick="loadCategory('kinh-di', 'Kinh Dị')"><div class="topic-name">Kinh Dị</div><div class="topic-link">Xem ngay <i class="fas fa-arrow-right"></i></div></div>
        </div>
    </div>

    <main id="main-content">
        <div class="merged-block">
            <div class="country-section">
                <div class="country-header">
                    <div class="ch-title">Phim <span class="text-gradient">Hàn Quốc</span></div>
                    <div class="ch-link" onclick="openModal('han-quoc', 'Phim Hàn Quốc')">Xem tất cả <i class="fas fa-chevron-right"></i></div>
                </div>
                <div class="grid-wrapper">
                    <button class="nav-arrow arrow-prev" onclick="scrollGrid('koreaList', -1)"><i class="fas fa-chevron-left"></i></button>
                    <div class="country-grid" id="koreaList"></div>
                    <button class="nav-arrow arrow-next" onclick="scrollGrid('koreaList', 1)"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>

            <div class="country-section">
                <div class="country-header">
                    <div class="ch-title">Phim <span class="text-gradient">Trung Quốc</span></div>
                    <div class="ch-link" onclick="openModal('trung-quoc', 'Phim Trung Quốc')">Xem tất cả <i class="fas fa-chevron-right"></i></div>
                </div>
                <div class="grid-wrapper">
                    <button class="nav-arrow arrow-prev" onclick="scrollGrid('chinaList', -1)"><i class="fas fa-chevron-left"></i></button>
                    <div class="country-grid" id="chinaList"></div>
                    <button class="nav-arrow arrow-next" onclick="scrollGrid('chinaList', 1)"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>

            <div class="country-section">
                <div class="country-header">
                    <div class="ch-title">Phim <span class="text-gradient">Thái Lan</span></div>
                    <div class="ch-link" onclick="openModal('thai-lan', 'Phim Thái Lan')">Xem tất cả <i class="fas fa-chevron-right"></i></div>
                </div>
                <div class="grid-wrapper">
                    <button class="nav-arrow arrow-prev" onclick="scrollGrid('thaiList', -1)"><i class="fas fa-chevron-left"></i></button>
                    <div class="country-grid" id="thaiList"></div>
                    <button class="nav-arrow arrow-next" onclick="scrollGrid('thaiList', 1)"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>
    </main>

    <div id="history-container"></div>

    <section class="top-10-wrapper">
        <div class="top-10-header">
            <i class="fas fa-fire" style="color:var(--primary-color); font-size: 2.5rem;"></i>
            <h2>TOP 5 THỊNH HÀNH</h2>
        </div>
        <div class="top-5-grid" id="top5List"></div>
    </section>

    <div id="modalPopup" class="modal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:45px; border-bottom:1px solid #222; padding-bottom:20px;">
            <h2 id="modalTitle" class="text-gradient" style="font-size: 2.2rem;">Danh sách phim</h2>
            <i class="fas fa-times" onclick="closeModal()" style="font-size:2.8rem; color:#fff; cursor:pointer;"></i>
        </div>
        <div id="modalContent" class="modal-grid"></div>
    </div>

    <footer>
        <div class="footer-grid">
            <div class="footer-col">
                <div class="footer-brand"><img src="/logo.webp" alt="HopPhim"><span class="logo-text">HOPPHIM</span></div>
                <p style="color: #a0a0a0; line-height: 1.6; margin-top: 15px;">Trang xem phim trực tuyến miễn phí chất lượng cao.</p>
            </div>
            <div class="footer-col">
                <h3>Danh mục</h3>
                <ul>
                    <li><a href="#" onclick="loadCategory('phim-moi', 'Phim Mới Cập Nhật')">Phim Mới Cập Nhật</a></li>
                    <li><a href="#" onclick="loadCategory('phim-le', 'Phim Lẻ')">Phim Chiếu Rạp</a></li>
                    <li><a href="#" onclick="loadCategory('phim-bo', 'Phim Bộ')">Phim Bộ Độc Quyền</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h3>Quốc gia</h3>
                <ul>
                    <li><a href="#" onclick="loadCountry('han-quoc', 'Hàn Quốc')">Hàn Quốc</a></li>
                    <li><a href="#" onclick="loadCountry('trung-quoc', 'Trung Quốc')">Trung Quốc</a></li>
                    <li><a href="#" onclick="loadCountry('au-my', 'Âu Mỹ')">Âu Mỹ</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h3>Hỗ trợ</h3>
                <ul>
                    <li><a href='/lienhequangcao'>Liên hệ quảng cáo</a></li>
                    <li><a href='/baoloi'>Báo lỗi</a></li>
                    <li><a href='/hopteam'>Về HopTeam</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom"><p>&copy; 2026 HopPhim. All Rights Reserved By HopTeam.</p></div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAT6SnKojUmsisDhnuEtsL3H59NwrhZxDc",
            authDomain: "hopphim-29e1c.firebaseapp.com",
            projectId: "hopphim-29e1c",
            storageBucket: "hopphim-29e1c.firebasestorage.app",
            messagingSenderId: "1076044580405",
            appId: "1:1076044580405:web:a3485f8533604f305e537c",
            measurementId: "G-6RT4CX2NR0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI Elements
        const btnLogin = document.getElementById('btnLogin');
        const userAvatar = document.getElementById('userAvatar');
        const userMenu = document.getElementById('userMenu');
        const mobileMemberBtn = document.getElementById('mobileMemberBtn');
        const mobileMemberText = document.getElementById('mobileMemberText');
        const mobileAccountLink = document.getElementById('mobileAccountLink');
        const historyContainer = document.getElementById('history-container');

        let currentUser = null;

        // AUTH FUNCTIONS
        window.logout = async () => {
            const ok = await window.customConfirm("Bạn có chắc muốn đăng xuất?");
            if(ok) {
                await signOut(auth);
                userMenu.classList.remove('active');
                closeMobileMenu();
                window.showToast("Đã đăng xuất!", "success");
            }
        }
        window.toggleUserDropdown = () => userMenu.classList.toggle('active');

        // AUTH STATE OBSERVER
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const photo = user.photoURL || '/Guest.webp';
                const name = user.displayName || 'Thành viên';

                btnLogin.style.display = 'none';
                userAvatar.style.display = 'block';
                userAvatar.src = photo;
                document.getElementById('userNameDisplay').innerText = name;

                mobileMemberText.innerText = name;
                mobileMemberBtn.innerHTML = `<img src="${photo}" style="width:30px;height:30px;border-radius:50%;object-fit:cover;border:2px solid var(--primary-color)"> <span>${name}</span>`;
                mobileMemberBtn.onclick = () => window.location.href = '/profile.html';
                mobileAccountLink.style.display = 'flex';

                loadHistory(user.uid);
            } else {
                currentUser = null;
                btnLogin.style.display = 'block';
                userAvatar.style.display = 'none';
                userMenu.classList.remove('active');

                mobileMemberText.innerText = "Đăng nhập / Đăng ký";
                mobileMemberBtn.innerHTML = `<i class="fas fa-user-circle"></i> <span>Đăng nhập / Đăng ký</span>`;
                mobileMemberBtn.onclick = () => window.location.href='/login.html';
                mobileAccountLink.style.display = 'none';

                historyContainer.innerHTML = '';
            }
        });

        // 1. HELPER: SHOW TOAST
        window.showToast = (msg, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            toast.innerHTML = `<i class="fas ${icon}"></i> <span>${msg}</span>`;
            
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 2. HELPER: CUSTOM CONFIRM
        window.customConfirm = (message) => {
            return new Promise((resolve) => {
                const overlay = document.getElementById('confirmModal');
                const msgEl = document.getElementById('confirmMsg');
                const btnYes = document.getElementById('btnConfirmYes');
                const btnNo = document.getElementById('btnConfirmNo');

                msgEl.innerText = message;
                overlay.classList.add('active');

                btnYes.onclick = () => { overlay.classList.remove('active'); resolve(true); };
                btnNo.onclick = () => { overlay.classList.remove('active'); resolve(false); };
            });
        }

        // 3. XÓA KHỎI LỊCH SỬ
        window.removeFromHistory = async (slug) => {
            if(!currentUser) return;
            const confirm = await window.customConfirm("Bạn có chắc muốn xóa phim này khỏi lịch sử?");
            if(!confirm) return;

            const userRef = doc(db, "users", currentUser.uid);
            try {
                const docSnap = await getDoc(userRef);
                if(!docSnap.exists()) return;

                let history = docSnap.data().watchHistory || [];
                const newHistory = history.filter(m => m.slug !== slug);
                
                await updateDoc(userRef, { watchHistory: newHistory });
                
                if (newHistory.length === 0) {
                    historyContainer.innerHTML = ''; 
                } else {
                    renderHistoryRow(newHistory.slice().reverse()); 
                }
                window.showToast("Đã xóa khỏi lịch sử!");
            } catch(e) { 
                console.error(e);
                window.showToast("Lỗi khi xóa phim!", "error");
            }
        }

        // 4. THÊM VÀO DANH SÁCH
        window.addToMyList = async (movieSlug, movieName, thumbUrl) => {
            if (!currentUser) {
                window.showToast("Vui lòng đăng nhập để lưu!", "error");
                return setTimeout(() => window.location.href = '/login.html', 1500);
            }

            const userRef = doc(db, "users", currentUser.uid);
            try {
                const docSnap = await getDoc(userRef);
                let list = docSnap.exists() ? (docSnap.data().myList || []) : [];
                
                if (list.some(m => m.slug === movieSlug)) {
                    window.showToast("Phim đã có trong danh sách!", "error");
                    return;
                }
                
                list.push({ slug: movieSlug, name: movieName, thumb_url: thumbUrl, timestamp: Date.now() });
                
                if(docSnap.exists()) await updateDoc(userRef, { myList: list });
                else await setDoc(userRef, { email: currentUser.email, myList: list });

                window.showToast("Đã thêm vào danh sách yêu thích!");
            } catch (e) { window.showToast("Lỗi lưu phim: " + e.message, "error"); }
        };

        // LOAD HISTORY
        async function loadHistory(uid) {
            try {
                const docSnap = await getDoc(doc(db, "users", uid));
                if(docSnap.exists() && docSnap.data().watchHistory && docSnap.data().watchHistory.length > 0) {
                    const history = docSnap.data().watchHistory.reverse();
                    renderHistoryRow(history);
                } else {
                    historyContainer.innerHTML = ''; 
                }
            } catch(e) { console.error(e); }
        }

        function renderHistoryRow(movies) {
            const section = document.createElement('section');
            section.className = 'category-section';
            const rowId = 'history-row';
            const html = movies.map(m => window.createHistoryCardHTML(m)).join('');
            
            section.innerHTML = `
                <div class="category-header">
                    <h2 class="category-title text-gradient"><i class="fas fa-history"></i> Xem tiếp</h2>
                </div>
                <div class="slider-container">
                    <button class="slider-arrow arrow-left" onclick="window.slide('${rowId}', -1)"><i class="fas fa-chevron-left"></i></button>
                    <div class="movie-row" id="${rowId}">${html}</div>
                    <button class="slider-arrow arrow-right" onclick="window.slide('${rowId}', 1)"><i class="fas fa-chevron-right"></i></button>
                </div>`;
            historyContainer.innerHTML = '';
            historyContainer.appendChild(section);
        }
    </script>

    <script>
        const API_BASE = 'https://ophim1.com/v1/api';
        const IMG_BASE = 'https://img.ophim1.com/uploads/movies/';

        // --- TOP 5 Logic (Smaller numbers) ---
        const MANUAL_TOP_5 = ["con-ra-the-thong-gi-nua", "dia-nguc-doc-than-phan-5", "tieng-yeu-nay-anh-dich-duoc-khong", "con-say-mua-xuan", "kho-do-danh"];
        
        async function loadTop5() {
            const container = document.getElementById('top5List');
            let html = '';
            for (let i = 0; i < MANUAL_TOP_5.length; i++) {
                try {
                    const res = await fetch(`${API_BASE}/phim/${MANUAL_TOP_5[i]}`);
                    const data = await res.json();
                    if(data.status) {
                        const m = data.data.item;
                        const img = m.thumb_url.startsWith('http') ? m.thumb_url : IMG_BASE + m.poster_url;
                        html += `
                        <div class="top-card-style2" onclick="window.location.href='/xem-phim/${m.slug}'">
                            <div class="top-poster-style2">
                                <img src="${img}" loading="lazy">
                                <div style="position:absolute; top:12px; right:12px; background:var(--primary-color); color:#fff; font-size:0.7rem; font-weight:900; padding:3px 8px; border-radius:6px;">${m.quality || 'HD'}</div>
                            </div>
                            <div class="top-info-row">
                                <div class="top-rank-style2">${i+1}</div>
                                <div class="top-text-style2">
                                    <div class="top-title-style2">${m.name}</div>
                                    <div class="top-meta-style2">${m.origin_name}</div>
                                </div>
                            </div>
                        </div>`;
                    }
                } catch(e) {}
            }
            container.innerHTML = html;
        }

        // --- MERGED BLOCK LOADER ---
        async function loadCountrySection(slug, elementId) {
            try {
                const res = await fetch(`${API_BASE}/quoc-gia/${slug}?page=1`);
                const data = await res.json();
                if(data.data) {
                    let html = '';
                    // Fetch up to 16 but show 4 per row
                    data.data.items.slice(0, 16).forEach(m => {
                        const img = m.thumb_url.startsWith('http') ? m.thumb_url : IMG_BASE + m.thumb_url;
                        const shortDesc = `Bộ phim ${m.name} (${m.origin_name}) ra mắt năm ${m.year} là một siêu phẩm điện ảnh không thể bỏ qua tại HopPhim.`;
                        
                        html += `
                        <div class="n-card">
                            <img src="${img}" class="n-poster" loading="lazy">
                            <div class="n-hover-detail" onclick="window.location.href='/xem-phim/${m.slug}'">
                                <img src="${img}" class="n-hover-img">
                                <div class="n-popup-body">
                                    <div class="n-actions">
                                        <button class="btn-play-now"><i class="fas fa-play"></i> PHÁT NGAY</button>
                                        <button class="btn-icon-round" onclick="event.stopPropagation(); addToMyList('${m.slug}', '${m.name}', '${m.thumb_url}')"><i class="fas fa-plus"></i></button>
                                        <button class="btn-icon-round"><i class="fas fa-thumbs-up"></i></button>
                                    </div>
                                    <div class="n-title">${m.name}</div>
                                    <div class="n-meta-row">
                                        <span class="match-score">98% Phù hợp</span>
                                        <span class="badge-hd">${m.quality || 'HD'}</span>
                                        <span>${m.year}</span>
                                    </div>
                                    <div class="n-desc">${shortDesc}</div>
                                </div>
                            </div>
                            <div class="c-info"><div class="c-title">${m.name}</div></div>
                        </div>`;
                    });
                    document.getElementById(elementId).innerHTML = html;
                }
            } catch(e) {}
        }

        // Slider Control
        window.scrollGrid = (id, direction) => {
            const el = document.getElementById(id);
            const step = el.clientWidth; 
            el.scrollBy({ left: direction * step, behavior: 'smooth' });
        };

        // Modal Catalog
        window.openModal = async (slug, title) => {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalPopup').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            const res = await fetch(`${API_BASE}/quoc-gia/${slug}?page=1`);
            const data = await res.json();
            const container = document.getElementById('modalContent');
            let html = '';
            if(data.data) {
                data.data.items.forEach(m => {
                    const img = m.thumb_url.startsWith('http') ? m.thumb_url : IMG_BASE + m.thumb_url;
                    html += `
                    <div class="modal-card" onclick="window.location.href='/xem-phim/${m.slug}'">
                        <img src="${img}" loading="lazy">
                        <div class="card-info-modal">
                            <div style="font-weight:700; font-size:0.9rem;">${m.name}</div>
                        </div>
                    </div>`;
                });
            }
            container.innerHTML = html;
        }

        window.closeModal = () => { document.getElementById('modalPopup').classList.remove('active'); document.body.style.overflow = 'auto'; }
        window.openMobileMenu = () => document.getElementById('mobileMenuOverlay').classList.add('active');
        window.closeMobileMenu = () => document.getElementById('mobileMenuOverlay').classList.remove('active');
        window.openMobileSearch = () => { document.getElementById('mobileSearchOverlay').classList.add('active'); document.getElementById('mobileSearchInput').focus(); };
        window.closeMobileSearch = () => document.getElementById('mobileSearchOverlay').classList.remove('active');
        window.loadHome = () => window.location.href = '/';

        window.renderHistoryRow = (movies) => {
            const container = document.getElementById('history-container');
            if(!movies || movies.length === 0) return;
            let html = `<div class="top-10-wrapper" style="margin-top:0; padding-bottom:40px;"><div class="top-10-header"><i class="fas fa-history" style="color:var(--primary-color); font-size:1.8rem;"></i><h2 style="font-size:2rem;">XEM TIẾP</h2></div><div class="top-5-grid">`;
            movies.forEach(m => {
                const img = m.thumb_url.startsWith('http') ? m.thumb_url : IMG_BASE + m.thumb_url;
                html += `<div class="top-card-style2" onclick="window.location.href='/xem-phim/${m.slug}'"><div class="top-poster-style2" style="aspect-ratio:16/9;"><img src="${img}"></div><div class="top-info-row" style="margin-top:10px;"><div class="top-text-style2"><div class="top-title-style2" style="font-size:1rem;">${m.name}</div></div></div></div>`;
            });
            html += `</div></div>`;
            container.innerHTML = html;
        }

        window.showToast = (msg, type='success') => {
            const t = document.createElement('div'); t.className=`toast ${type}`; 
            const icon = type === 'success' ? 'check-circle' : 'exclamation-circle';
            t.innerHTML=`<i class="fas fa-${icon}"></i><span>${msg}</span>`;
            document.getElementById('toast-container').appendChild(t); setTimeout(()=>t.remove(), 3500);
        }

        window.customConfirm = (msg) => {
            return new Promise(r => {
                document.getElementById('confirmMsg').innerText=msg;
                document.getElementById('confirmModal').classList.add('active');
                document.getElementById('btnConfirmYes').onclick=()=>{document.getElementById('confirmModal').classList.remove('active');r(true)};
                document.getElementById('btnConfirmNo').onclick=()=>{document.getElementById('confirmModal').classList.remove('active');r(false)};
            })
        }

        // Init App Lifecycle
        window.addEventListener('scroll', () => {
            document.getElementById('siteHeader').classList.toggle('scrolled', window.scrollY > 60);
        });

        window.addEventListener('load', () => {
            loadTop5();
            loadCountrySection('han-quoc', 'koreaList');
            loadCountrySection('trung-quoc', 'chinaList');
            loadCountrySection('thai-lan', 'thaiList');
            setTimeout(() => {
                const ls = document.getElementById('loadingScreen');
                ls.style.opacity = '0';
                setTimeout(() => ls.style.display = 'none', 600);
            }, 1200);
        });
    </script>
</body>
</html>