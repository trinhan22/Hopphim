<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - WibuPhim</title>
    
    <link rel="icon" type="image/webp" href="/LOGO.WEBP" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-body: #0b0d14;
            --bg-panel: #1a1d26;
            --primary: #FF5E62;
            --secondary: #FF8F50;
            --text-main: #ffffff;
            --text-sub: #a0a0a0;
            --success: #4ade80;
            --border: rgba(255, 255, 255, 0.08);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); padding-bottom: 50px; display: none; /* ·∫®n body m·∫∑c ƒë·ªãnh cho ƒë·∫øn khi x√°c minh admin */ }

        header {
            height: 70px; background: #0f111a; padding: 0 4%;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--border); margin-bottom: 30px;
        }
        .admin-title { font-weight: 800; font-size: 1.2rem; text-transform: uppercase; color: var(--primary); }
        .back-link { color: var(--text-sub); text-decoration: none; font-size: 0.9rem; }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: var(--bg-panel); padding: 25px; border-radius: 20px; border: 1px solid var(--border); text-align: center; }
        .stat-val { font-size: 2rem; font-weight: 900; color: var(--primary); display: block; }
        .stat-label { color: var(--text-sub); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }

        .table-container { background: var(--bg-panel); border-radius: 20px; border: 1px solid var(--border); overflow: hidden; }
        .table-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th { padding: 15px 20px; background: rgba(255,255,255,0.02); color: var(--text-sub); font-size: 0.85rem; text-transform: uppercase; }
        td { padding: 15px 20px; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
        
        .action-btns { display: flex; gap: 10px; }
        .btn { border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 0.85rem; color: #fff; transition: 0.3s; }
        .btn-approve { background: var(--success); }
        .btn-approve:hover { transform: scale(1.05); }
        .btn-delete { background: rgba(255,255,255,0.05); color: #ff4444; }

        .loading { padding: 50px; text-align: center; color: var(--text-sub); }
        code { background: #000; padding: 4px 8px; border-radius: 5px; color: var(--secondary); font-family: monospace; }
    </style>
</head>
<body>

    <header>
        <div class="admin-title"><i class="fas fa-user-shield"></i> WibuPhim Admin</div>
        <a href="/" class="back-link"><i class="fas fa-arrow-left"></i> V·ªÅ trang ch·ªß</a>
    </header>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-val" id="count-pending">0</span>
                <span class="stat-label">ƒê∆°n ƒëang ch·ªù</span>
            </div>
            <div class="stat-card">
                <span class="stat-val" id="total-revenue" style="color: var(--success);">0ƒë</span>
                <span class="stat-label">∆Ø·ªõc t√≠nh doanh thu</span>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <h3>Danh s√°ch y√™u c·∫ßu n·∫°p ti·ªÅn</h3>
                <span style="font-size: 0.8rem; color: var(--success);"><i class="fas fa-circle"></i> Live Sync</span>
            </div>
            
            <table id="request-table">
                <thead>
                    <tr>
                        <th>Kh√°ch h√†ng</th>
                        <th>G√≥i n·∫°p</th>
                        <th>N·ªôi dung (Code)</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody id="request-body"></tbody>
            </table>
            <div id="no-data" class="loading" style="display: none;">üéâ Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o c·∫ßn duy·ªát!</div>
            <div id="initial-loading" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, collection, query, where, onSnapshot, updateDoc, deleteDoc, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAT6SnKojUmsisDhnuEtsL3H59NwrhZxDc", authDomain: "hopphim-29e1c.firebaseapp.com", projectId: "hopphim-29e1c", storageBucket: "hopphim-29e1c.firebasestorage.app", messagingSenderId: "1076044580405", appId: "1:1076044580405:web:a3485f8533604f305e537c" };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- H√ÄNG R√ÄO B·∫¢O M·∫¨T EMAIL ---
        const ALLOWED_ADMINS = ["nhanntfct30802@gmail.com", "ntrinhan712@gmail.com"];

        onAuthStateChanged(auth, (user) => {
            if (user && ALLOWED_ADMINS.includes(user.email)) {
                // H·ª£p l·ªá -> Hi·ªán giao di·ªán v√† load data
                document.body.style.display = "block";
                loadRequests();
            } else {
                // Kh√¥ng h·ª£p l·ªá -> ƒêu·ªïi v·ªÅ trang ch·ªß
                window.location.href = "/index.html";
                alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p khu v·ª±c n√†y!");
            }
        });

        function loadRequests() {
            const q = query(collection(db, "topupRequests"), where("status", "==", "pending"));
            
            onSnapshot(q, (snapshot) => {
                document.getElementById('initial-loading').style.display = 'none';
                const body = document.getElementById('request-body');
                body.innerHTML = "";
                
                let pendingCount = 0;
                let revenue = 0;

                if (snapshot.empty) {
                    document.getElementById('no-data').style.display = 'block';
                } else {
                    document.getElementById('no-data').style.display = 'none';
                    snapshot.forEach((docSnap) => {
                        const data = docSnap.data();
                        pendingCount++;
                        revenue += data.amount;

                        const row = `
                            <tr>
                                <td><strong>${data.email}</strong></td>
                                <td><strong>${data.amount.toLocaleString()}ƒë</strong><br><small>+${data.coinRequested || data.coinTotal} Coin</small></td>
                                <td><code>${data.transferCode}</code></td>
                                <td><span style="color:var(--secondary)">ƒêang ch·ªù</span></td>
                                <td>
                                    <div class="action-btns">
                                        <button class="btn btn-approve" onclick="approveTopup('${docSnap.id}', '${data.uid}', ${data.coinRequested || data.coinTotal})">DUY·ªÜT</button>
                                        <button class="btn btn-delete" onclick="deleteRequest('${docSnap.id}')">X√ìA</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        body.innerHTML += row;
                    });
                }
                document.getElementById('count-pending').innerText = pendingCount;
                document.getElementById('total-revenue').innerText = revenue.toLocaleString() + "ƒë";
            });
        }

        // Logic Duy·ªát
        window.approveTopup = async (requestId, userId, coinAmount) => {
            if(!confirm("X√°c nh·∫≠n ƒë√£ nh·∫≠n ti·ªÅn v√† duy·ªát ƒë∆°n?")) return;
            try {
                await updateDoc(doc(db, "users", userId), { coinBalance: increment(coinAmount) });
                await updateDoc(doc(db, "topupRequests", requestId), { status: "completed" });
                alert("Duy·ªát th√†nh c√¥ng!");
            } catch (e) { alert("L·ªói: " + e.message); }
        };

        // Logic X√≥a
        window.deleteRequest = async (requestId) => {
            if(!confirm("X√≥a ƒë∆°n n√†y?")) return;
            try { await deleteDoc(doc(db, "topupRequests", requestId)); } catch (e) { alert("L·ªói: " + e.message); }
        };
    </script>
</body>
</html>