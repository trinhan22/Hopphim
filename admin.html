<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - WibuPhim</title>
    
    <link rel="icon" type="image/webp" href="/LOGO.WEBP" />
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- 1. SETUP M√ÄU S·∫ÆC (NEW TONE: MATTE BLACK) --- */
        :root {
            /* Tone n·ªÅn: ƒêen x√°m l√¨ (Zinc) - R·∫•t d·ªãu v√† sang */
            --bg-body: #191b24; 
            --bg-card: #23252f;
            --bg-card-hover: #191b24;
            
            /* M√†u nh·∫•n: Gi·ªØ nguy√™n ƒë·ªÉ nh·∫≠n di·ªán th∆∞∆°ng hi·ªáu */
            --primary: #FF5E62; 
            --gradient: linear-gradient(135deg, #FF9966, #FF5E62);
            
            /* Text & Border */
            --text-main: #e4e4e7; /* Tr·∫Øng ng√†, ko b·ªã ch√≥i */
            --text-sub: #a1a1aa;  /* X√°m nh·∫°t */
            --border: 1px solid rgba(255,255,255,0.08);
            
            /* Status Colors */
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            
            --font: 'Be Vietnam Pro', sans-serif;
            --radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font); outline: none; }
        
        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            min-height: 100vh;
            display: none; /* ·∫®n tr∆∞·ªõc khi login */
            padding-bottom: 50px;
        }

        /* --- 2. HEADER --- */
        header {
            height: 80px;
            background: #191b24; /* N·ªÅn m·ªù hi·ªán ƒë·∫°i */
            backdrop-filter: blur(12px);
            padding: 0 4%;
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        /* Ph·∫ßn Logo b√™n tr√°i */
        .header-logo-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .header-logo-group img {
            height: 42px; /* K√≠ch th∆∞·ªõc logo */
            object-fit: contain;
            filter: drop-shadow(0 0 5px rgba(255, 94, 98, 0.4)); /* Glow nh·∫π cho logo */
        }
        .header-brand-text {
            font-size: 1.5rem;
            font-weight: 900;
            letter-spacing: 1px;
            background: linear-gradient(90deg, #FF5E62, #FF9966);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
        }

        /* N√∫t Admin Dashboard b√™n ph·∫£i */
        .home-link-btn {
            text-decoration: none;
            color: #a1a1aa;
            font-size: 0.85rem;
            font-weight: 800;
            letter-spacing: 1px;
            text-transform: uppercase;
            padding: 10px 20px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .home-link-btn:hover {
            background: rgba(255, 94, 98, 0.1);
            color: #FF5E62;
            border-color: #FF5E62;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 94, 98, 0.15);
        }

        /* --- 3. LAYOUT & CARDS --- */
        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; animation: fadeIn 0.5s ease; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        
        .stat-card {
            background: var(--bg-card); border-radius: var(--radius); padding: 25px;
            border: var(--border); display: flex; align-items: center; gap: 20px;
            transition: 0.3s; box-shadow: var(--shadow);
        }
        .stat-card:hover { transform: translateY(-5px); border-color: rgba(255, 94, 98, 0.3); }
        
        .stat-icon-box { 
            width: 60px; height: 60px; border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; font-size: 1.8rem;
        }
        .icon-pending { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .icon-revenue { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        
        .stat-info span { display: block; font-size: 0.85rem; color: var(--text-sub); text-transform: uppercase; margin-bottom: 5px; }
        .stat-info strong { font-size: 1.8rem; font-weight: 700; line-height: 1; }

        /* --- 4. TABLE STYLES --- */
        .table-container { background: var(--bg-card); border-radius: var(--radius); border: var(--border); overflow: hidden; box-shadow: var(--shadow); }
        
        .table-header { padding: 20px 25px; border-bottom: var(--border); display: flex; justify-content: space-between; align-items: center; }
        .table-header h3 { font-size: 1.1rem; font-weight: 700; }
        .live-tag { font-size: 0.75rem; color: var(--success); display: flex; align-items: center; gap: 5px; background: rgba(16, 185, 129, 0.1); padding: 4px 10px; border-radius: 20px; }
        .dot { width: 6px; height: 6px; background: var(--success); border-radius: 50%; animation: pulse 1.5s infinite; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px 25px; color: var(--text-sub); font-size: 0.8rem; text-transform: uppercase; background: rgba(0,0,0,0.2); font-weight: 600; }
        td { padding: 18px 25px; border-bottom: var(--border); font-size: 0.95rem; color: var(--text-main); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: var(--bg-card-hover); }

        .user-email { font-weight: 600; color: #fff; display: block; }
        .user-id { font-size: 0.75rem; color: var(--text-sub); font-family: monospace; }
        
        .amount-badge { background: rgba(255, 94, 98, 0.1); color: var(--primary); padding: 5px 10px; border-radius: 6px; font-weight: 700; font-size: 0.9rem; }
        .code-box { background: #000; padding: 6px 10px; border-radius: 6px; font-family: monospace; letter-spacing: 1px; color: #cbd5e1; border: 1px dashed rgba(255,255,255,0.15); }
        
        .status-badge { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; background: rgba(245, 158, 11, 0.15); color: var(--warning); }

        /* --- 5. BUTTONS --- */
        .action-btns { display: flex; gap: 8px; justify-content: flex-end; }
        .btn { border: none; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
        .btn-approve { background: var(--success); color: #fff; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2); }
        .btn-approve:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(16, 185, 129, 0.3); filter: brightness(1.1); }
        .btn-delete { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }
        .btn-delete:hover { background: var(--danger); color: #fff; }

        /* --- 6. TOAST NOTIFICATION --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { 
            background: var(--bg-card); color: #fff; padding: 15px 25px; border-radius: 10px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); border-left: 4px solid var(--primary);
            display: flex; align-items: center; gap: 12px; min-width: 300px;
            animation: slideInRight 0.3s ease;
        }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }

        /* --- 7. CUSTOM CONFIRM MODAL --- */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            z-index: 10000; display: none; justify-content: center; align-items: center; 
            opacity: 0; transition: 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }
        
        .confirm-box { 
            background: var(--bg-card); width: 400px; padding: 30px; border-radius: 16px; 
            text-align: center; border: 1px solid var(--border); box-shadow: var(--shadow);
            transform: scale(0.9); transition: 0.3s;
        }
        .modal-overlay.active .confirm-box { transform: scale(1); }
        
        .confirm-icon { font-size: 3rem; color: var(--warning); margin-bottom: 15px; }
        .confirm-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 10px; color: #fff; }
        .confirm-desc { color: var(--text-sub); margin-bottom: 25px; line-height: 1.5; font-size: 0.95rem; }
        
        .modal-actions { display: flex; gap: 15px; justify-content: center; }
        .btn-modal { padding: 10px 25px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-modal-cancel { background: transparent; border: 1px solid var(--border); color: var(--text-sub); }
        .btn-modal-cancel:hover { color: #fff; border-color: #fff; }
        .btn-modal-ok { background: var(--gradient); color: #fff; }
        .btn-modal-ok:hover { transform: translateY(-2px); }

        /* States */
        .loading-state { padding: 50px; text-align: center; color: var(--text-sub); display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite; }
        
        .empty-state { padding: 60px; text-align: center; color: var(--text-sub); display: none; }
        .empty-state i { font-size: 3rem; opacity: 0.2; margin-bottom: 15px; display: block; }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

    <header>
        <div class="header-logo-group">
            <img src="/LOGO.WEBP" alt="WibuPhim Logo">
            <span class="header-brand-text">WIBUPHIM</span>
        </div>
        <a href="/" class="home-link-btn">TRANG CH·ª¶ <i class="fas fa-external-link-alt" style="font-size: 0.8rem;"></i></a>
    </header>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon-box icon-pending"><i class="fas fa-clock"></i></div>
                <div class="stat-info">
                    <span>ƒê∆°n ch·ªù duy·ªát</span>
                    <strong id="count-pending">0</strong>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon-box icon-revenue"><i class="fas fa-coins"></i></div>
                <div class="stat-info">
                    <span>Doanh thu ∆∞·ªõc t√≠nh</span>
                    <strong id="total-revenue">0ƒë</strong>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <h3>Danh s√°ch y√™u c·∫ßu n·∫°p ti·ªÅn</h3>
                <div class="live-tag"><div class="dot"></div> Real-time</div>
            </div>

            <table id="request-table">
                <thead>
                    <tr>
                        <th>Kh√°ch h√†ng</th>
                        <th>G√≥i n·∫°p</th>
                        <th>M√£ giao d·ªãch</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th style="text-align: right;">H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="request-body"></tbody>
            </table>

            <div id="initial-loading" class="loading-state">
                <div class="spinner"></div>
                <span>ƒêang t·∫£i d·ªØ li·ªáu...</span>
            </div>
            
            <div id="no-data" class="empty-state">
                <i class="fas fa-clipboard-check"></i>
                <p>Tuy·ªát v·ªùi! Kh√¥ng c√≥ y√™u c·∫ßu n√†o c·∫ßn x·ª≠ l√Ω.</p>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <div id="confirmModal" class="modal-overlay">
        <div class="confirm-box">
            <div class="confirm-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <h3 class="confirm-title">X√°c nh·∫≠n thao t√°c</h3>
            <p class="confirm-desc" id="confirmMsg">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën th·ª±c hi·ªán h√†nh ƒë·ªông n√†y?</p>
            <div class="modal-actions">
                <button class="btn-modal btn-modal-cancel" id="btnModalCancel">H·ªßy b·ªè</button>
                <button class="btn-modal btn-modal-ok" id="btnModalOk">ƒê·ªìng √Ω</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        // üî• QUAN TR·ªåNG: Import ƒë·∫ßy ƒë·ªß setDoc ƒë·ªÉ fix l·ªói
        import { getFirestore, doc, collection, query, where, onSnapshot, updateDoc, deleteDoc, setDoc, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAT6SnKojUmsisDhnuEtsL3H59NwrhZxDc", authDomain: "hopphim-29e1c.firebaseapp.com", projectId: "hopphim-29e1c", storageBucket: "hopphim-29e1c.firebasestorage.app", messagingSenderId: "1076044580405", appId: "1:1076044580405:web:a3485f8533604f305e537c" };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // EMAIL ADMIN
        const ALLOWED_ADMINS = ["nhanntfct30802@gmail.com", "ntrinhan712@gmail.com"];

        onAuthStateChanged(auth, (user) => {
            if (user && ALLOWED_ADMINS.includes(user.email)) {
                document.body.style.display = "block";
                loadRequests();
            } else {
                window.location.href = "/index.html";
                alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p Admin Panel!");
            }
        });

        // --- GLOBAL HELPERS ---
        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${type==='success'?'fa-check-circle':'fa-exclamation-circle'}"></i> <span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function customConfirm(msg) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const msgEl = document.getElementById('confirmMsg');
                const btnOk = document.getElementById('btnModalOk');
                const btnCancel = document.getElementById('btnModalCancel');

                msgEl.innerText = msg;
                modal.classList.add('active');

                const handleOk = () => { cleanup(); resolve(true); };
                const handleCancel = () => { cleanup(); resolve(false); };
                function cleanup() { modal.classList.remove('active'); btnOk.removeEventListener('click', handleOk); btnCancel.removeEventListener('click', handleCancel); }
                btnOk.addEventListener('click', handleOk);
                btnCancel.addEventListener('click', handleCancel);
            });
        }

        function loadRequests() {
            const q = query(collection(db, "topupRequests"), where("status", "==", "pending"));
            onSnapshot(q, (snapshot) => {
                document.getElementById('initial-loading').style.display = 'none';
                const body = document.getElementById('request-body');
                body.innerHTML = "";
                let pendingCount = 0; let revenue = 0;

                if (snapshot.empty) {
                    document.getElementById('no-data').style.display = 'block';
                    document.getElementById('request-table').style.display = 'none';
                } else {
                    document.getElementById('no-data').style.display = 'none';
                    document.getElementById('request-table').style.display = 'table';
                    snapshot.forEach((docSnap) => {
                        const data = docSnap.data();
                        pendingCount++; revenue += data.amount;
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><div class="user-cell"><span class="user-email">${data.email}</span><span class="user-id">ID: ${data.uid.substring(0, 10)}...</span></div></td>
                            <td><div class="amount-badge">${data.amount.toLocaleString()}ƒë</div><div style="font-size:0.8rem; color:#aaa; margin-top:5px;">+${data.coinRequested || data.coinTotal} Coin</div></td>
                            <td><div class="code-box">${data.transferCode}</div></td>
                            <td><span class="status-badge"><i class="fas fa-clock"></i> ƒêang ch·ªù</span></td>
                            <td style="text-align: right;"><div class="action-btns"><button class="btn btn-delete"><i class="fas fa-trash"></i> X√≥a</button><button class="btn btn-approve"><i class="fas fa-check"></i> Duy·ªát</button></div></td>`;
                        row.querySelector('.btn-approve').onclick = () => approveTopup(docSnap.id, data.uid, (data.coinRequested || data.coinTotal));
                        row.querySelector('.btn-delete').onclick = () => deleteRequest(docSnap.id);
                        body.appendChild(row);
                    });
                }
                document.getElementById('count-pending').innerText = pendingCount;
                document.getElementById('total-revenue').innerText = revenue.toLocaleString() + "ƒë";
            }, (error) => {
                if (error.code === 'permission-denied') {
                    document.body.innerHTML = '<div style="text-align:center; padding:50px; color:#fff;"><h2>üö´ Access Denied</h2><p>B·∫°n kh√¥ng c√≥ quy·ªÅn xem d·ªØ li·ªáu n√†y. Vui l√≤ng c·∫•u h√¨nh Firestore Rules.</p></div>';
                }
            });
        }

        // --- LOGIC DUY·ªÜT ƒê∆†N (ƒê√É FIX L·ªñI NO DOCUMENT) ---
        async function approveTopup(requestId, userId, coinAmount) {
            const confirmed = await customConfirm(`X√°c nh·∫≠n ƒë√£ nh·∫≠n ti·ªÅn v√† c·ªông ${coinAmount} Coin cho User?`);
            if (!confirmed) return;
            try {
                // S·ª≠ d·ª•ng setDoc(..., {merge: true}) ƒë·ªÉ t·ª± ƒë·ªông t·∫°o user n·∫øu ch∆∞a t·ªìn t·∫°i
                const userRef = doc(db, "users", userId);
                await setDoc(userRef, { coinBalance: increment(coinAmount) }, { merge: true });
                await updateDoc(doc(db, "topupRequests", requestId), { status: "completed" });
                showToast(`ƒê√£ duy·ªát th√†nh c√¥ng! +${coinAmount} Coin`, 'success');
            } catch (e) { showToast("L·ªói: " + e.message, 'error'); }
        };

        async function deleteRequest(requestId) {
            const confirmed = await customConfirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën X√ìA y√™u c·∫ßu n√†y?");
            if (!confirmed) return;
            try { await deleteDoc(doc(db, "topupRequests", requestId)); showToast("ƒê√£ x√≥a y√™u c·∫ßu!", 'success'); } 
            catch (e) { showToast("L·ªói: " + e.message, 'error'); }
        };
    </script>
</body>
</html>