<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêang xem phim - WibuPhim</title>
    
    <meta property="og:title" content="WibuPhim - Phim Hay Trong T·∫ßm Tay" />
    <meta property="og:description" content="Trang xem phim tr·ª±c tuy·∫øn mi·ªÖn ph√≠ ch·∫•t l∆∞·ª£ng cao." />
    <meta property="og:image" content="https://wibuphim.netlify.app/panel.webp" />
    <meta property="og:url" content="https://wibuphim.netlify.app" />
    <meta property="og:type" content="article" />

    <link rel="icon" type="image/webp" href="/LOGO.WEBP" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        :root { --plyr-color-main: #FF5E62; }
        .plyr--full-ui input[type=range] { color: var(--plyr-color-main); }
        .plyr__control--overlaid { background: var(--plyr-color-main); }
        .plyr--video .plyr__control.plyr__tab-focus, 
        .plyr--video .plyr__control:hover, 
        .plyr--video .plyr__control[aria-expanded=true] {
            background: var(--plyr-color-main);
        }
        /* Ch·ªânh l·∫°i khung ch·ª©a ƒë·ªÉ kh√¥ng b·ªã l·ªói hi·ªÉn th·ªã */
        .player-box {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        #player-container {
            width: 100%;
            background: #000;
        }
        .plyr {
            aspect-ratio: 16/9;
            width: 100%;
        }
        .aspect-ratio-16-9 {
            padding-top: 0 !important; /* X√≥a b·ªè padding g√¢y d∆∞ th·ª´a */
            height: auto !important;
        }
        .plyr__video-embed iframe { top: -50%; height: 200%; }
    </style>

    <style>
        /* --- CSS GLOBAL --- */
        :root {
            --bg-body: #191b24; 
            --bg-dark: #0f111a; 
            --text-main: #ffffff; 
            --text-sub: #a0a0a0; 
            --bg-card: #23252f;
            --gradient-main: linear-gradient(90deg, #FF8F50, #FF5E62); 
            --primary-color: #FF5E62;
            --radius: 12px;
            --font-main: 'Inter', sans-serif;
            --mobile-menu-bg: #15171e; 
            --mobile-border: rgba(255,255,255,0.05);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: var(--font-main); background-color: var(--bg-body); color: var(--text-main); overflow-x: hidden; }
        .text-gradient { background: var(--gradient-main); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: inline-block; }

        /* --- QU·∫¢NG C√ÅO (ADS - FIX T·ªà L·ªÜ ·∫¢NH) --- */
        #ad-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            
            /* üî• QUAN TR·ªåNG: M·∫∑c ƒë·ªãnh ·∫©n, ch·ªù JS ki·ªÉm tra xong m·ªõi hi·ªán */
            display: none; 
            
            justify-content: center; align-items: center;
            z-index: 99999; transition: opacity 0.5s ease, visibility 0.5s ease;
            padding: 20px;
        }
        
        #ad-container {
            /* T·ª± ƒë·ªông co gi√£n theo k√≠ch th∆∞·ªõc ·∫£nh */
            width: auto; 
            height: auto;
            
            /* Gi·ªõi h·∫°n k√≠ch th∆∞·ªõc t·ªëi ƒëa ƒë·ªÉ kh√¥ng qu√° to */
            max-width: 90vw; 
            max-height: 90vh;
            
            background-color: transparent; /* Xo√° n·ªÅn ƒëen th·ª´a */
            border-radius: 12px; 
            overflow: hidden; 
            position: relative; 
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); 
            transform: scale(1); 
            transition: transform 0.5s ease;
            
            /* CƒÉn gi·ªØa n·ªôi dung b√™n trong */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #ad-image { 
            /* ƒê·∫£m b·∫£o ·∫£nh lu√¥n hi·ªÉn th·ªã tr·ªçn v·∫πn, kh√¥ng b·ªã m√©o/c·∫Øt */
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            display: block; 
            z-index: 10; 
            cursor: pointer; 
            max-width: 100%; /* ƒê·∫£m b·∫£o ·∫£nh kh√¥ng tr√†n ra ngo√†i container */
            max-height: 90vh; /* Gi·ªõi h·∫°n chi·ªÅu cao ·∫£nh */
        }

        /* N√∫t Skip & Go to website gi·ªØ nguy√™n */
        #skip-button, #go-to-website-button {
            position: absolute; top: 10px; padding: 8px 12px; 
            background-color: rgba(0, 0, 0, 0.7); 
            backdrop-filter: blur(5px); /* Th√™m hi·ªáu ·ª©ng m·ªù n·ªÅn cho n√∫t ƒë·∫πp h∆°n */
            color: white; border: none; border-radius: 4px; 
            font-weight: 600; font-size: 14px; 
            cursor: pointer; z-index: 1000; transition: all 0.2s ease;
        }
        #go-to-website-button { left: 10px; }
        #skip-button { right: 10px; cursor: not-allowed; }
        #skip-button.enabled { background-color: #FF8F50; cursor: pointer; }
        
        /* --- LOADING & TOAST --- */
        /* ==========================================================================
           4. LOADING SCREEN
           ========================================================================== 
        */
        #loadingScreen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh; 
            background: var(--bg-body); z-index: 9999; display: flex; 
            justify-content: center; align-items: center; 
        }
        
        .loading-img { 
            width: 800px; /* Ch·ªânh l·∫°i k√≠ch th∆∞·ªõc cho v·ª´a v·∫∑n */
            max-width: 90vw; height: auto; object-fit: contain; 
            /* Animation m·∫∑c ƒë·ªãnh: Hi·ªán ra -> Bay l∆° l·ª≠ng */
            animation: zoomIn 0.8s ease-out forwards, floatIdle 3s ease-in-out infinite 0.8s; 
        }
        
        /* Class n√†y s·∫Ω ƒë∆∞·ª£c JS th√™m v√†o khi t·∫£i xong */
        .loading-img.zoom-out { 
            /* D√πng ease-in ƒë·ªÉ t·∫°o c·∫£m gi√°c h√∫t nhanh v√†o trong */
            animation: zoomOut 0.5s ease-in forwards !important; 
        }

        /* Hi·ªáu ·ª©ng l√∫c m·ªõi v√†o trang */
        @keyframes zoomIn { 0% { transform: scale(1.36); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes floatIdle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        /* --- üî• S·ª¨A ƒêO·∫†N N√ÄY: H√öT V√ÄO TRONG --- */
        @keyframes zoomOut { 
            36% { transform: scale(1); opacity: 1; } 
            100% { transform: scale(0.36); opacity: 0; } /* scale(0) l√† thu nh·ªè bi·∫øn m·∫•t */
        }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: #23252f; color: #fff; padding: 15px 25px; border-radius: 12px; display: flex; align-items: center; gap: 12px; min-width: 300px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border-left: 4px solid var(--primary-color); animation: slideInRight 0.3s ease; pointer-events: auto; }
        .toast.success { border-left-color: #2ecc71; } .toast.error { border-left-color: #ff4757; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- CONFIRM POPUP --- */
        .custom-confirm-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 10001; display: none; justify-content: center; align-items: center; opacity: 0; transition: 0.3s; backdrop-filter: blur(5px); }
        .custom-confirm-overlay.active { display: flex; opacity: 1; }
        .confirm-box { background: #1f222e; width: 90%; max-width: 400px; padding: 30px; border-radius: 16px; text-align: center; border: 1px solid rgba(255,255,255,0.1); transform: scale(0.9); transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .custom-confirm-overlay.active .confirm-box { transform: scale(1); }
        .confirm-icon { font-size: 3rem; margin-bottom: 15px; background: var(--gradient-main); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .confirm-title { font-size: 1.2rem; font-weight: 700; color: #fff; margin-bottom: 10px; }
        .confirm-desc { font-size: 0.95rem; color: var(--text-sub); margin-bottom: 25px; line-height: 1.5; }
        .confirm-actions { display: flex; gap: 15px; justify-content: center; }
        .btn-confirm { padding: 10px 25px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; transition: 0.2s; font-size: 0.95rem; }
        .btn-cancel { background: transparent; color: #ccc; border: 1px solid rgba(255,255,255,0.2); } .btn-cancel:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-ok { background: var(--gradient-main); color: #fff; box-shadow: 0 4px 15px rgba(255, 94, 98, 0.3); } .btn-ok:hover { transform: translateY(-2px); }

        /* --- MODAL POPUP --- */
        .modal { display: none; position: fixed; inset: 0; z-index: 2000; background: rgba(15, 17, 26, 0.95); padding: 40px; overflow-y: auto; }
        .modal.active { display: block; }
        .modal-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .modal-grid .movie-card { width: 100%; height: 280px; }

        /* --- HEADER PC --- */
        header { position: fixed; top: 0; width: 100%; height: 70px; padding: 0 4%; display: flex; justify-content: space-between; align-items: center; z-index: 1000; background: var(--bg-dark); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4); }
        .header-left-group { display: flex; align-items: center; gap: 30px; height: 100%; }
        .logo { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .logo img { height: 40px; object-fit: contain; }
        .logo-text { font-size: 1.5rem; font-weight: 900; letter-spacing: 1px; text-transform: uppercase; background: var(--gradient-main); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* Nav Links */
        .nav-links { display: flex; gap: 15px; list-style: none; height: 100%; align-items: center; }
        
        /* Item c·ªßa Menu */
        .nav-item { 
            position: relative; height: 100%; display: flex; align-items: center; 
            padding: 0 10px; cursor: pointer;
        }
        
        .nav-link { 
            color: #ccc; text-decoration: none; font-size: 14px; font-weight: 600; 
            text-transform: uppercase; transition: 0.3s; white-space: nowrap; 
            display: flex; align-items: center; gap: 5px;
        }
        .nav-item:hover .nav-link { color: #fff; }
        .nav-link i { font-size: 0.8rem; margin-top: -2px; }

        /* DROPDOWN MENU (B·∫¢NG X·ªî XU·ªêNG) */
        .dropdown-menu { display: none; position: absolute; top: 70px; left: 0; background: rgba(15, 17, 26, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-top: 2px solid var(--primary-color); padding: 20px; border-radius: 0 0 12px 12px; width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); animation: fadeIn 0.2s ease-out; }
        .nav-item:hover .dropdown-menu { display: block; }
        .dropdown-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .dropdown-item-link { color: #a0a0a0; text-decoration: none; font-size: 0.9rem; padding: 5px 8px; border-radius: 6px; transition: 0.2s; }
        .dropdown-item-link:hover { color: #fff; background: rgba(255,255,255,0.1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .right-elements { display: flex; align-items: center; gap: 15px; }
        .search-box { display: flex; align-items: center; background: #23252f; padding: 8px 16px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.05); }
        .search-box input { background: transparent; border: none; color: #fff; margin-left: 10px; font-family: var(--font-main); font-size: 14px; width: 150px; }
        .menu-toggle, .mobile-search-trigger { display: none; font-size: 1.5rem; color: #fff; cursor: pointer; }
        
        .btn-login { background: var(--gradient-main); color: #fff; border: none; padding: 8px 20px; border-radius: 50px; font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: 0.3s; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary-color); cursor: pointer; display: none; object-fit: cover; }
        .user-dropdown { position: absolute; top: 100%; right: 0; width: 200px; margin-top: 15px; background: #23252f; border-radius: 8px; padding: 5px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: none; flex-direction: column; border: 1px solid rgba(255,255,255,0.1); }
        .user-dropdown.active { display: flex; }
        .user-info-item { padding: 12px; color: #fff; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .dropdown-item { background: transparent; border: none; color: #ccc; text-align: left; padding: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .dropdown-item:hover { background: rgba(255,255,255,0.1); color: #fff; }
        

        /* --- MOBILE OVERLAYS --- */
        .mobile-overlay { display: none; position: fixed; inset: 0; z-index: 3000; transition: 0.3s ease-in-out; }
        .mobile-overlay.active { transform: translateX(0) !important; opacity: 1 !important; }
        .close-btn-overlay { position: absolute; font-size: 1.8rem; color: #fff; cursor: pointer; z-index: 10; }
        
        #mobileMenuOverlay { display: block; background: var(--mobile-menu-bg); transform: translateX(-100%); padding: 25px; width: 300px; box-shadow: 5px 0 20px rgba(0,0,0,0.5); }
        .menu-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .menu-logo { display: flex; align-items: center; gap: 10px; } .menu-logo img { height: 35px; } .menu-logo span { font-weight: 800; font-size: 1.2rem; background: var(--gradient-main); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        #mobileMenuOverlay .close-btn-overlay { position: static; color: #fff; opacity: 0.7; }
        .member-btn-large { width: 100%; padding: 12px; background: linear-gradient(90deg, #FF8F50, #FF5E62); color: #fff; border: none; border-radius: 8px; font-weight: 700; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 25px; cursor: pointer; }
        .mobile-menu-grid { display: flex; flex-direction: column; gap: 5px; max-height: 80vh; overflow-y: auto; }
        .mobile-menu-link { color: #ccc; text-decoration: none; font-weight: 600; font-size: 1rem; padding: 12px 0; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid var(--mobile-border); }
        .mobile-menu-link i { width: 25px; color: var(--primary-color); text-align: center; }

        #mobileSearchOverlay { display: block; background: #1f212d; transform: translateY(-100%); opacity: 0; }
        #mobileSearchOverlay.active { transform: translateY(0) !important; opacity: 1 !important; }
        .search-header-mobile { display: flex; align-items: center; padding: 15px 20px; background: #2a2d3a; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .search-input-mobile { flex: 1; background: transparent; border: none; color: #fff; font-size: 1rem; font-family: var(--font-main); margin-right: 15px; }
        #mobileSearchOverlay .close-btn-overlay { position: static; color: #fff; }

        /* --- XEM PHIM LAYOUT --- */
        .container { max-width: 1400px; margin: 0 auto; padding: 0 4%; }
        .watch-wrapper { display: grid; grid-template-columns: 2.8fr 1.2fr; gap: 30px; padding-top: 100px; padding-bottom: 50px; }
        
        .player-box { background: #000; border-radius: var(--radius); overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; position: relative; }
        .aspect-ratio-16-9 { width: 100%; padding-top: 56.25%; position: relative; }
        .aspect-ratio-16-9 iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }

        /* Movie Info Block */
        .movie-info-block { position: relative; background: #161823; padding: 30px; border-radius: 16px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); overflow: hidden; }
        .movie-info-bg { position: absolute; inset: 0; background-size: cover; background-position: center; opacity: 0.20; filter: blur(10px) saturate(150%); pointer-events: none; }
        .movie-info-content { position: relative; z-index: 1; }
        .movie-breadcrumbs { font-size: 0.9rem; color: var(--text-sub); margin-bottom: 15px; display: flex; gap: 8px; align-items: center; }
        .movie-breadcrumbs a { color: #ccc; text-decoration: none; } .movie-breadcrumbs a:hover { color: var(--primary-color); }
        .movie-title-large { font-size: 2.4rem; font-weight: 900; margin-bottom: 5px; line-height: 1.2; text-transform: uppercase; background: var(--gradient-main); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .movie-origin-name { font-size: 1.1rem; color: #a0a0a0; margin-bottom: 20px; font-weight: 600; }
        .movie-tags { display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; align-items: center; }
        .tag-item { padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 700; color: #ccc; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.05); }
        .tag-highlight { background: var(--gradient-main); color: #fff; border: none; }
        .movie-description { color: #d1d5db; line-height: 1.7; font-size: 1rem; background: rgba(0,0,0,0.2); padding: 20px; border-radius: 12px; border-left: 3px solid var(--primary-color); }

        .episode-block { background: var(--bg-card); padding: 25px; border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; }
        .section-header { font-size: 1.2rem; font-weight: 700; margin-bottom: 20px; border-left: 4px solid var(--primary-color); padding-left: 10px; color: #fff; display: flex; justify-content: space-between; align-items: center; }
        .episode-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; max-height: 400px; overflow-y: auto; }
        .ep-btn { background: #191b24; color: #fff; border: 1px solid rgba(255,255,255,0.1); padding: 10px 0; text-align: center; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .ep-btn:hover, .ep-btn.active { background: var(--gradient-main); border-color: transparent; }

        /* Comment Section */
        .comment-section { background: #161823; padding: 30px; border-radius: 16px; margin-top: 30px; border: 1px solid rgba(255,255,255,0.05); }
        .comment-header-title { font-size: 1.2rem; font-weight: 700; color: #fff; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; border-left: 4px solid var(--primary-color); padding-left: 15px; }
        .comment-input-box { display: flex; gap: 20px; margin-bottom: 40px; align-items: flex-start; }
        .current-user-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); }
        .comment-form { flex: 1; background: #1f222e; border-radius: 12px; padding: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .comment-input { width: 100%; background: transparent; border: none; color: #fff; font-family: var(--font-main); font-size: 0.95rem; resize: none; min-height: 60px; outline: none; }
        .form-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.05); }
        .btn-send-cmt { background: var(--gradient-main); color: #fff; border: none; padding: 8px 24px; border-radius: 20px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .comment-list { display: flex; flex-direction: column; gap: 25px; }
        .comment-item { display: flex; gap: 15px; animation: fadeIn 0.5s ease; }
        .comment-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 1px solid rgba(255,255,255,0.1); }
        .comment-body { flex: 1; }
        .comment-meta { display: flex; align-items: baseline; gap: 10px; margin-bottom: 5px; }
        .comment-author { font-weight: 700; font-size: 0.95rem; color: #fff; }
        .comment-text { color: #ccc; font-size: 0.95rem; line-height: 1.5; background: rgba(255,255,255,0.03); padding: 12px 15px; border-radius: 0 12px 12px 12px; display: inline-block; }
        
        /* --- CSS CƒÇN GI·ªÆA TH√îNG B√ÅO B√åNH LU·∫¨N --- */
        .empty-comment {
            text-align: center;         /* CƒÉn gi·ªØa ch·ªØ */
            width: 100%;                /* Chi·∫øm to√†n b·ªô chi·ªÅu r·ªông */
            padding: 20px 0;           /* Th√™m kho·∫£ng c√°ch tr√™n d∆∞·ªõi cho tho√°ng */
            color: #a0a0a0;             /* M√†u ch·ªØ x√°m nh·∫°t */
            font-size: 0.95rem;         /* K√≠ch th∆∞·ªõc ch·ªØ */
            font-style: italic;         /* In nghi√™ng cho ƒë·∫πp */
            display: flex;              /* D√πng Flexbox ƒë·ªÉ cƒÉn gi·ªØa icon v√† ch·ªØ */
            flex-direction: column;     /* X·∫øp d·ªçc (icon tr√™n, ch·ªØ d∆∞·ªõi) */
            align-items: center;        /* CƒÉn gi·ªØa theo tr·ª•c ngang */
            gap: 10px;                  /* Kho·∫£ng c√°ch gi·ªØa icon v√† ch·ªØ */
        }
        
        .empty-comment i {
            font-size: 2rem;            /* Icon to l√™n m·ªôt ch√∫t */
            color: #a0a0a0; /* Icon m√†u ch·ªß ƒë·∫°o */
            opacity: 0.7;               /* L√†m m·ªù icon m·ªôt ch√∫t */
            margin-bottom: 5px;
        }

        /* Sidebar Card */
        .sidebar-right { position: sticky; top: 90px; height: fit-content; }
        .sidebar-card { display: flex; gap: 15px; margin-bottom: 15px; padding: 10px; background: var(--bg-card); border-radius: 8px; transition: 0.2s; cursor: pointer; border: 1px solid transparent; }
        .sidebar-card:hover { background: #2a2d3a; border-color: rgba(255, 94, 98, 0.3); transform: translateX(-5px); }
        .sb-thumb { width: 70px; height: 100px; flex-shrink: 0; border-radius: 6px; overflow: hidden; }
        .sb-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .sb-info { display: flex; flex-direction: column; justify-content: center; }
        .sb-title { font-size: 0.95rem; font-weight: 700; margin-bottom: 5px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; color: #fff; }
        .sb-meta { font-size: 0.8rem; color: var(--text-sub); }

/* =========================================
   FOOTER REDESIGN (WIBUPHIM x WIBUPAD STYLE)
   ========================================= */
footer {
    background: #0b0c12; /* M√†u n·ªÅn t·ªëi h∆°n body m·ªôt ch√∫t ƒë·ªÉ t√°ch bi·ªát */
    border-top: 1px solid rgba(255, 255, 255, 0.05);
    padding: 80px 4% 30px;
    margin-top: 80px;
    position: relative;
    z-index: 100;
}

.footer-grid {
    display: grid;
    grid-template-columns: 1.5fr 1fr 1fr 1.2fr; /* C·ªôt Logo v√† Download to h∆°n ch√∫t */
    gap: 40px;
    margin-bottom: 50px;
}

/* --- C·ªôt 1: Brand --- */
.footer-logo {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
}

.footer-logo img {
    height: 45px;
    width: auto;
    object-fit: contain;
}

.footer-logo .brand-text {
    font-size: 1.6rem;
    font-weight: 900;
    letter-spacing: 1px;
    text-transform: uppercase;
}

.footer-desc {
    color: var(--text-sub);
    line-height: 1.6;
    font-size: 0.95rem;
    margin-bottom: 25px;
    max-width: 90%;
}

.footer-socials {
    display: flex;
    gap: 12px;
}

.social-link {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #ccc;
    transition: 0.3s;
    text-decoration: none;
    font-size: 1.1rem;
}

.social-link:hover {
    background: var(--gradient-main);
    color: #fff;
    border-color: transparent;
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(255, 94, 98, 0.3);
}

/* --- C√°c c·ªôt Link --- */
.footer-col h4 {
    color: #fff;
    font-size: 1rem;
    font-weight: 800;
    margin-bottom: 25px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.footer-links {
    list-style: none;
    padding: 0;
}

.footer-links li {
    margin-bottom: 15px;
}

.footer-links a {
    color: var(--text-sub);
    text-decoration: none;
    transition: 0.3s;
    font-size: 0.95rem;
    display: block;
    font-weight: 500;
}

.footer-links a:hover {
    color: var(--primary-color);
    transform: translateX(5px);
}

/* --- C·ªôt 4: Download Buttons --- */
.download-group {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.btn-download-app {
    background: rgba(255, 255, 255, 0.03);
    color: #fff;
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 10px 16px;
    border-radius: 10px;
    cursor: pointer;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.3s ease;
    width: 100%;
    max-width: 220px;
}

.btn-download-app i {
    font-size: 1.6rem;
    color: #ccc;
    transition: 0.3s;
}

.btn-content {
    line-height: 1.3;
}

.btn-small-text {
    font-size: 0.7rem;
    color: #888;
    display: block;
}

.btn-big-text {
    font-size: 1rem;
    font-weight: 700;
    color: #fff;
}

.btn-download-app:hover {
    border-color: var(--primary-color);
    background: rgba(255, 94, 98, 0.05);
    transform: translateY(-2px);
}

.btn-download-app:hover i {
    color: var(--primary-color);
}

/* --- Footer Bottom --- */
.footer-bottom {
    border-top: 1px solid rgba(255, 255, 255, 0.05);
    padding-top: 30px;
    text-align: center;
    color: #555;
    font-size: 0.85rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* --- Responsive Mobile --- */
@media (max-width: 900px) {
    .footer-grid {
        grid-template-columns: 1fr;
        gap: 40px;
        text-align: center;
    }

    .footer-logo, .footer-socials {
        justify-content: center;
    }

    .footer-desc {
        margin: 0 auto 25px;
    }

    .footer-col h4 {
        margin-bottom: 15px;
    }
    
    .download-group {
        align-items: center;
    }
    
    .footer-bottom {
        flex-direction: column;
        gap: 10px;
    }
}
        
        @media (max-width: 900px) {
            header { height: 60px; padding: 0 4%; justify-content: space-between; }
            .header-left-group { gap: 25px; order: 1; }
            .menu-toggle { display: block; font-size: 1.5rem; }
            .logo { order: 2; margin: 0; } .logo img { height: 32px; } .logo-text { display: block; font-size: 1.2rem; }
            .right-elements { order: 3; gap: 15px; }
            .mobile-search-trigger { display: block; font-size: 1.2rem; }
            .nav-links, .search-box, .desktop-auth { display: none !important; }
            #mobileMenuOverlay, #mobileSearchOverlay { display: block; }
            .watch-wrapper { grid-template-columns: 1fr; padding-top: 80px; gap: 20px; }
            .movie-title-large { font-size: 1.8rem; }
            .movie-info-block { padding: 20px; }
            .player-box { order: 1; }
            .episode-block-mobile { order: 2; display: block !important; margin-bottom: 20px; }
            .comment-section { order: 4; }
            .sidebar-right { order: 5; position: static; }
            .episode-block-desktop { display: none; }
            .footer-grid { grid-template-columns: 1fr; gap: 40px; text-align: center; }
            .footer-col ul { display: flex; flex-direction: column; align-items: center; }
            .footer-brand { justify-content: center; }
        }
        @media (min-width: 901px) { .episode-block-mobile { display: none; } }

/* CSS cho k·∫øt qu·∫£ t√¨m ki·∫øm */
.search-result-item {
    display: flex; gap: 15px; padding: 12px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    cursor: pointer; transition: 0.2s;
}
.search-result-item:hover { background: rgba(255,255,255,0.08); }
.search-result-item img { width: 55px; height: 80px; object-fit: cover; border-radius: 6px; }

.search-result-info { display: flex; flex-direction: column; justify-content: center; }
.search-result-title { color: #fff; font-weight: 700; font-size: 0.95rem; margin-bottom: 4px; }
.search-result-meta { color: #888; font-size: 0.8rem; }

/* Container k·∫øt qu·∫£ Desktop (Th√™m c√°i n√†y ƒë·ªÉ Desktop c≈©ng hi·ªán k·∫øt qu·∫£) */
#desktopSearchResults {
    position: absolute;
    top: 110%;
    right: 0;
    width: 380px;
    background: rgba(31, 33, 45, 0.95);
    backdrop-filter: blur(15px);
    border-radius: 12px;
    box-shadow: 0 15px 50px rgba(0,0,0,0.8);
    max-height: 450px;
    overflow-y: auto;
    display: none;
    z-index: 10002;
    border: 1px solid rgba(255,255,255,0.1);
}
#desktopSearchResults.active { display: block; animation: fadeIn 0.2s ease; }

#desktopSearchResults::-webkit-scrollbar { width: 5px; }
#desktopSearchResults::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }

        /* Custom Scroller */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-color); }

/* =========================================
   FACEBOOK COMMUNITY CARD
   ========================================= */
.community-section {
    max-width: 1400px;
    margin: 0 auto 60px; /* C√°ch d∆∞·ªõi 60px */
    padding: 0 4%;
}

.comm-card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    /* N·ªÅn Gradient t·ª´ Xanh Facebook sang ƒêen c·ªßa Web */
    background: linear-gradient(105deg, #1877F2 0%, #0f111a 60%);
    padding: 45px 50px;
    border-radius: 24px;
    text-decoration: none;
    position: relative;
    overflow: hidden;
    box-shadow: 0 15px 40px rgba(24, 119, 242, 0.25);
    border: 1px solid rgba(255,255,255,0.1);
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
}

/* Hi·ªáu ·ª©ng Hover: N·ªïi l√™n v√† s√°ng h∆°n */
.comm-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 60px rgba(24, 119, 242, 0.4);
    border-color: rgba(255,255,255,0.3);
}

/* Ph·∫ßn b√™n tr√°i: Icon + Text */
.comm-left {
    display: flex;
    align-items: center;
    gap: 25px;
    z-index: 2;
}

.comm-icon {
    width: 60px; height: 60px;
    background: #fff;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 2rem; color: #1877F2;
    box-shadow: 0 0 20px rgba(255,255,255,0.3);
}

.comm-title {
    font-size: 1.5rem;
    font-weight: 900;
    color: #fff;
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.comm-desc {
    font-size: 0.95rem;
    color: rgba(255,255,255,0.8);
    font-weight: 500;
}

/* Ph·∫ßn b√™n ph·∫£i: N√∫t tham gia */
.comm-btn {
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
    color: #fff;
    padding: 12px 28px;
    border-radius: 50px;
    font-weight: 700;
    display: flex; align-items: center; gap: 10px;
    transition: 0.3s;
    z-index: 2;
}

.comm-card:hover .comm-btn {
    background: #fff;
    color: #1877F2;
}

/* H√¨nh n·ªÅn trang tr√≠ m·ªù ph√≠a sau */
.comm-bg-deco {
    position: absolute;
    right: -20px; top: -50%;
    font-size: 15rem;
    color: rgba(255,255,255,0.05);
    transform: rotate(15deg);
    pointer-events: none;
    transition: 0.4s;
}
.comm-card:hover .comm-bg-deco {
    transform: rotate(0deg) scale(1.1);
    color: rgba(255,255,255,0.1);
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .comm-card {
        flex-direction: column;
        text-align: center;
        padding: 30px 20px;
        gap: 20px;
    }
    .comm-left { flex-direction: column; gap: 15px; }
    .comm-bg-deco { font-size: 10rem; top: 10%; right: -20%; }
    .comm-btn { width: 100%; justify-content: center; }
}


        /* --- PANEL QU·∫¢NG C√ÅO (ƒê√É CH·ªàNH 1456x180) --- */
        
        /* 2. Banner Qu·∫£ng C√°o: M·∫∑c ƒë·ªãnh ·∫©n */
        .ad-panel-wrapper {
            /* üî• QUAN TR·ªåNG: M·∫∑c ƒë·ªãnh ·∫©n */
            display: none;
            
            flex-direction: column; align-items: center; gap: 15px;
            margin: 0 auto 40px; padding: 0 4%; width: 80%; max-width: 1456px;
        }

        .ad-link {
            display: block;
            width: 100%;
            /* üëâ S·ª¨A: TƒÉng ƒë·ªô r·ªông t·ªëi ƒëa l√™n 1456px */
            max-width: 1456px; 
        }

        .ad-img-728 {
            width: 100%;
            /* üëâ S·ª¨A: ƒê·ªÉ height l√† auto ƒë·ªÉ n√≥ t·ª± co gi√£n theo t·ªâ l·ªá */
            height: auto; 
            
            /* üëâ QUAN TR·ªåNG: Thi·∫øt l·∫≠p t·ªâ l·ªá khung h√¨nh chu·∫©n 1456/180 
               Gi√∫p ·∫£nh lu√¥n gi·ªØ ƒë√∫ng t·ªâ l·ªá d√π ·ªü m√†n h√¨nh to hay nh·ªè */
            aspect-ratio: 1456 / 180;

            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            display: block;
        }

        /* --- T·ª± ƒë·ªông co gi√£n tr√™n ƒêi·ªán tho·∫°i (Mobile) --- */
        @media (max-width: 768px) {
            .ad-img-728 {
                height: auto;
                /* üëâ S·ª¨A: C·∫≠p nh·∫≠t t·ªâ l·ªá cho mobile c≈©ng theo k√≠ch th∆∞·ªõc m·ªõi */
                aspect-ratio: 1456 / 180; 
            }
        }

        /* --- T·ª± ƒë·ªông co gi√£n tr√™n ƒêi·ªán tho·∫°i (Mobile) --- */
        @media (max-width: 768px) {
            .ad-img-728 {
                height: auto; /* Tr√™n ƒëi·ªán tho·∫°i ƒë·ªÉ auto cho ·∫£nh t·ª± thu nh·ªè */
                
                /* üëâ QUAN TR·ªåNG: N·∫øu ·ªü tr√™n b·∫°n ƒë·ªïi k√≠ch th∆∞·ªõc th√†nh R·ªông 1000px, Cao 200px 
                Th√¨ ·ªü ƒë√¢y b·∫°n s·ª≠a th√†nh: aspect-ratio: 1000/200; ƒë·ªÉ tr√™n mobile ko b·ªã m√©o */
                aspect-ratio: 728/90; 
            }
        }

/* Style huy hi·ªáu s·ªë d∆∞ c·∫°nh t√™n */
.balance-badge {
    background: rgba(255, 215, 0, 0.15);
    color: #FFD700;
    padding: 2px 10px;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 800;
    border: 1px solid rgba(255, 215, 0, 0.4);
    margin-left: 8px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    vertical-align: middle;
    text-transform: none;
}
.balance-badge i {
    font-size: 0.7rem;
    filter: drop-shadow(0 0 3px rgba(255, 215, 0, 0.6));
}

/* --- STYLE CHO B√åNH LU·∫¨N VIP --- */
.comment-item.is-vip .comment-avatar {
    border: 2px solid #FFD700;
    box-shadow: 0 0 10px #FFD700;
}
.comment-item.is-vip .comment-author {
    color: #FFD700 !important;
    text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
    display: inline-flex; align-items: center; gap: 5px;
}
.comment-item.is-vip .comment-text {
    background: linear-gradient(90deg, rgba(255, 215, 0, 0.1), transparent);
    border: 1px solid rgba(255, 215, 0, 0.3);
    color: #fff;
}

/* --- GIAO DI·ªÜN QU·∫¢NG C√ÅO YOUTUBE STYLE (FIXED) --- */
.preroll-container {
    width: 100%; height: 100%; background: #000;
    position: relative; overflow: hidden; display: flex;
    justify-content: center; align-items: center;
}
.preroll-gif { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }

/* G√≥c tr√™n tr√°i: D·ª• d·ªó n·∫°p VIP */
.preroll-info-box {
    position: absolute; top: 0; left: 0; padding: 25px;
    z-index: 10; pointer-events: none; /* ƒê·ªÉ kh√¥ng ch·∫∑n click */
}
.preroll-info-box p { 
    background: #f1c40f; color: #000; padding: 2px 6px; 
    font-size: 11px; font-weight: 900; border-radius: 2px; 
    display: inline-block; margin-bottom: 5px; text-transform: uppercase;
}
.preroll-info-box div { 
    color: #fff; font-size: 18px; font-weight: 500; 
    text-shadow: 0 2px 4px rgba(0,0,0,0.8); display: flex; align-items: center; gap: 8px;
}
.preroll-info-box div i { color: #FF5E62; animation: crownRotate 2s infinite; }

/* G√≥c d∆∞·ªõi ph·∫£i: N√∫t B·ªè qua */
.preroll-skip-area {
    position: absolute; bottom: 50px; right: 0; 
    z-index: 20; display: flex; align-items: center;
}
.btn-skip-preroll {
    background: rgba(0, 0, 0, 0.6); 
    color: #fff; border: none; padding: 12px 30px;
    font-size: 1.1rem; font-weight: 500;
    border-radius: 4px 0 0 4px;
    cursor: default; transition: 0.2s;
    backdrop-filter: blur(5px);
    display: flex; align-items: center; gap: 10px;
}
.btn-skip-preroll.ready {
    background: rgba(0, 0, 0, 0.9);
    cursor: pointer;
    border: 1px solid rgba(255,255,255,0.2); border-right: none;
}
.btn-skip-preroll.ready:hover { background: #333; }

/* --- ƒê·ªíNG B·ªò VIP KING T·ª™ INDEX --- */
.vip-glow {
    border: 2px solid #FFD700 !important;
    box-shadow: 0 0 15px #FFD700, 0 0 25px rgba(255, 215, 0, 0.4) !important;
    animation: vipPulse 2s infinite !important;
}
.vip-name {
    background: linear-gradient(to right, #FFD700, #FFF5C3, #FFD700);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: 900 !important;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    display: inline-flex; align-items: center; gap: 5px;
}
@keyframes vipPulse {
    0% { box-shadow: 0 0 5px #FFD700; }
    50% { box-shadow: 0 0 20px #FFD700; }
    100% { box-shadow: 0 0 5px #FFD700; }
}
/* Badge s·ªë d∆∞ */
.balance-badge {
    background: rgba(255, 215, 0, 0.15); color: #FFD700;
    padding: 2px 10px; border-radius: 50px;
    font-size: 0.75rem; font-weight: 800;
    border: 1px solid rgba(255, 215, 0, 0.4);
    margin-left: 8px; display: inline-flex; align-items: center; gap: 4px;
}
/* Style b√¨nh lu·∫≠n VIP */
.comment-item.is-vip .comment-avatar {
    border: 2px solid #FFD700 !important;
    box-shadow: 0 0 10px #FFD700 !important;
}
    </style>
</head>
<body>
    
    <div id="ad-overlay">
        <div id="ad-container">
            <button id="go-to-website-button">Go to website</button>
            <button id="skip-button" disabled>Skip ad (<span>3</span>)</button>
            <img id="ad-image" alt="Qu·∫£ng c√°o" title="Nh·∫•n ƒë·ªÉ xem chi ti·∫øt">
        </div>
    </div>

    <div id="loadingScreen">
        <img src="/Loading.png" class="loading-img" alt="WibuPhim">
    </div>

    <div id="toast-container"></div>

    <div id="confirmModal" class="custom-confirm-overlay">
        <div class="confirm-box">
            <div class="confirm-icon"><i class="fas fa-exclamation-circle"></i></div>
            <h3 class="confirm-title">X√°c nh·∫≠n</h3>
            <p class="confirm-desc" id="confirmMsg">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën th·ª±c hi·ªán h√†nh ƒë·ªông n√†y?</p>
            <div class="confirm-actions">
                <button class="btn-confirm btn-cancel" id="btnConfirmNo">H·ªßy b·ªè</button>
                <button class="btn-confirm btn-ok" id="btnConfirmYes">ƒê·ªìng √Ω</button>
            </div>
        </div>
    </div>

    <div id="modalPopup" class="modal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px; border-bottom:1px solid #222; padding-bottom:20px;">
            <h2 id="modalTitle" class="text-gradient" style="font-size: 2rem;">Danh s√°ch phim</h2>
            <i class="fas fa-times" onclick="closeModal()" style="font-size:2.5rem; color:#fff; cursor:pointer;"></i>
        </div>
        <div id="modalContent" class="modal-grid"></div>
    </div>

    <div id="mobileMenuOverlay" class="mobile-overlay">
        <div class="menu-header">
            <div class="menu-logo"><img src="/LOGO.WEBP" alt="WibuPhim"><span>WIBUPHIM</span></div>
             <i class="fas fa-times close-btn-overlay" onclick="closeMobileMenu()"></i>
        </div>
        <button class="member-btn-large" id="mobileMemberBtn" onclick="window.location.href='/login.html'">
            <i class="fas fa-user-circle"></i> <span id="mobileMemberText">ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω</span>
        </button>
        <div class="mobile-menu-grid">
            <a href="/" class="mobile-menu-link" onclick="closeMobileMenu()"><i class="fas fa-home"></i> Trang ch·ªß</a>
            
            <a href="#" class="mobile-menu-link" onclick="closeMobileMenu()"><i class="fas fa-tv"></i> Phim B·ªô</a>
            <a href="#" class="mobile-menu-link" onclick="closeMobileMenu()"><i class="fas fa-film"></i> Phim L·∫ª</a>

            <div style="border-bottom: 1px solid var(--mobile-border); padding: 10px 0; color:#666; font-size:0.9rem; font-weight:700; text-transform:uppercase; margin-top:10px;">Qu·∫£n L√Ω</div>
            <a href="../profile.html" class="mobile-menu-link" onclick="closeMobileMenu()"><i class="fas fa-user-cog"></i> T√†i Kho·∫£n</a>
            <div id="drawerLogout" class="drawer-item" style="color:#ff4757; display:none;" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</div>        </div>
    </div>

    <div id="mobileSearchOverlay" class="mobile-overlay">
        <div class="search-header-mobile">
            <i class="fas fa-search" style="color: #a0a0a0; margin-right: 10px;"></i>
            <input type="text" id="mobileSearchInput" class="search-input-mobile" placeholder="Nh·∫≠p t√™n phim..." autocomplete="off">
            <i class="fas fa-times close-btn-overlay" onclick="closeMobileSearch()"></i>
        </div>
        <div class="search-content-mobile">
            <div id="mobileSearchResults"></div>
        </div>
    </div>

    <header id="header">
        <div class="header-left-group">
            <div class="menu-toggle" onclick="openMobileMenu()"><i class="fas fa-bars"></i></div>
            <div class="logo" onclick="window.location.href='/'">
                <img src="/LOGO.WEBP" alt="WibuPhim"><span class="logo-text">WIBUPHIM</span>
            </div>
            
            <ul class="nav-links" id="navLinks">
                <li class="nav-item">
                    <a href="/" class="nav-link">Trang ch·ªß</a>
                </li>
                
                <li class="nav-item">
                    <div class="nav-link">Th·ªÉ lo·∫°i <i class="fas fa-caret-down"></i></div>
                    <div class="dropdown-menu">
                        <div class="dropdown-grid">
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('hanh-dong', 'H√†nh ƒê·ªông')">H√†nh ƒê·ªông</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('tinh-cam', 'T√¨nh C·∫£m')">T√¨nh C·∫£m</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('hai-huoc', 'H√†i H∆∞·ªõc')">H√†i H∆∞·ªõc</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('co-trang', 'C·ªï Trang')">C·ªï Trang</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('tam-ly', 'T√¢m L√Ω')">T√¢m L√Ω</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('hinh-su', 'H√¨nh S·ª±')">H√¨nh S·ª±</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('chien-tranh', 'Chi·∫øn Tranh')">Chi·∫øn Tranh</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('the-thao', 'Th·ªÉ Thao')">Th·ªÉ Thao</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('vo-thuat', 'V√µ Thu·∫≠t')">V√µ Thu·∫≠t</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('vien-tuong', 'Vi·ªÖn T∆∞·ªüng')">Vi·ªÖn T∆∞·ªüng</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('phieu-luu', 'Phi√™u L∆∞u')">Phi√™u L∆∞u</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('khoa-hoc', 'Khoa H·ªçc')">Khoa H·ªçc</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('kinh-di', 'Kinh D·ªã')">Kinh D·ªã</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('am-nhac', '√Çm Nh·∫°c')">√Çm Nh·∫°c</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('than-thoai', 'Th·∫ßn Tho·∫°i')">Th·∫ßn Tho·∫°i</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('tai-lieu', 'T√†i Li·ªáu')">T√†i Li·ªáu</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('gia-dinh', 'Gia ƒê√¨nh')">Gia ƒê√¨nh</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('hoc-duong', 'H·ªçc ƒê∆∞·ªùng')">H·ªçc ƒê∆∞·ªùng</a>
                            <a href="#" class="dropdown-item-link" onclick="loadCategory('short-drama', 'Short Drama')">Short Drama</a>
                        </div>
                    </div>
                </li>

                <li class="nav-item"><a href="#" class="nav-link" onclick="loadCategory('phim-le', 'Phim L·∫ª')">Phim L·∫ª</a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="loadCategory('phim-bo', 'Phim B·ªô')">Phim B·ªô</a></li>

                <li class="nav-item">
                    <div class="nav-link">Qu·ªëc gia <i class="fas fa-caret-down"></i></div>
                    <div class="dropdown-menu" style="width: 400px;">
                        <div class="dropdown-grid" style="grid-template-columns: repeat(3, 1fr);">
                            <a href="#" class="dropdown-item-link" onclick="openModal('trung-quoc', 'Phim Trung Qu·ªëc')">Trung Qu·ªëc</a>
                            <a href="#" class="dropdown-item-link" onclick="openModal('han-quoc', 'Phim H√†n Qu·ªëc')">H√†n Qu·ªëc</a>
                            <a href="#" class="dropdown-item-link" onclick="openModal('nhat-ban', 'Phim Nh·∫≠t B·∫£n')">Nh·∫≠t B·∫£n</a>
                            <a href="#" class="dropdown-item-link" onclick="openModal('thai-lan', 'Phim Th√°i Lan')">Th√°i Lan</a>
                            <a href="#" class="dropdown-item-link" onclick="openModal('au-my', 'Phim √Çu M·ªπ')">√Çu M·ªπ</a>
                            <a href="#" class="dropdown-item-link" onclick="openModal('dai-loan', 'Phim ƒê√†i Loan')">ƒê√†i Loan</a>
                            <a href="#" class="dropdown-item-link" onclick="openModal('hong-kong', 'Phim H·ªìng K√¥ng')">H·ªìng K√¥ng</a>
                            <a href="#" class="dropdown-item-link" onclick="openModal('an-do', 'Phim ·∫§n ƒê·ªô')">·∫§n ƒê·ªô</a>
                            <a href="#" class="dropdown-item-link" onclick="openModal('viet-nam', 'Phim Vi·ªát Nam')">Vi·ªát Nam</a>
                        </div>
                    </div>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="https://wibuteam.netlify.app" target="_blank">V·ªÅ WibuTeam</a>
                </li>
            </ul>
        </div>
        <div class="right-elements">
            <div class="mobile-search-trigger" onclick="openMobileSearch()"><i class="fas fa-search"></i></div>
            
            <div class="search-box desktop-auth" style="position: relative;"> 
                <i class="fas fa-search" style="color: #a0a0a0"></i>
                <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm phim..." autocomplete="off">
                <div id="desktopSearchResults"></div> 
            </div>

            <div class="desktop-auth" style="position: relative;">
                <button id="btnLogin" class="btn-login" onclick="window.location.href='/login.html'">ƒêƒÉng nh·∫≠p</button>
                <img id="userAvatar" class="user-avatar" src="" alt="User" onclick="toggleUserDropdown()">
                <div id="userMenu" class="user-dropdown">
                    <div id="userNameDisplay" class="user-info-item">User</div>
                    
                    <div id="vipStatus" style="padding: 10px; font-size: 0.8rem; color: #aaa; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <i class="fas fa-crown"></i> Free Plan
                    </div>

                    <button class="dropdown-item" onclick="window.buyVipPackage()">
                        <i class="fas fa-star" style="color: #FFD700;"></i> Mua VIP
                    </button>

                    <button class="dropdown-item" onclick="window.location.href='/nap-coin.html'"><i class="fa-duotone fa-solid fa-wallet"></i> N·∫°p Coin</button>
                    <button class="dropdown-item" onclick="window.location.href='/profile.html'"><i class="fas fa-user-cog"></i> T√†i kho·∫£n</button>
                    <button class="dropdown-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">

        <div class="watch-wrapper">

            <div class="main-content">
                <div class="player-box">
                    <div id="player-container">
                        <video id="player" playsinline controls></video>
                    </div>
                </div>

                <div class="episode-block episode-block-mobile">
                    <div class="section-header">
                        <span>Danh s√°ch t·∫≠p</span>
                        <span class="server-name"><i class="fas fa-server"></i> Server VIP</span>
                    </div>
                    <div class="episode-grid" id="episodeListMobile"></div>
                </div>

                <div class="movie-info-block">
                    <div id="movieInfoBg" class="movie-info-bg"></div>
                    
                    <div class="movie-info-content">
                        <div class="movie-breadcrumbs">
                            <a href="/">Trang ch·ªß</a> <i class="fas fa-chevron-right" style="font-size: 0.7rem; color: #555;"></i> <span id="breadCrumbTitle">ƒêang xem</span>
                        </div>
                        <h1 class="movie-title-large" id="mName">Loading...</h1>
                        <div class="movie-origin-name" id="mOrigin">Loading...</div>
                        
                        <div class="movie-tags" id="mTags"></div>
                        
                        <div class="movie-description">
                            <h4 style="color:#fff; margin-bottom:10px; font-size:1rem;">N·ªôi dung phim</h4>
                            <span id="mContent">ƒêang t·∫£i n·ªôi dung phim...</span>
                        </div>
                    </div>
                </div>

                <div class="comment-section">
                    <div class="comment-header-title">
                        <i class="fas fa-comments" style="color: var(--primary-color);"></i> 
                        B√¨nh lu·∫≠n
                    </div>
                    
                    <div class="comment-input-box">
                        <img src="/Guest.webp" id="cmtMyAvatar" class="current-user-avatar">
                        <div class="comment-form">
                            <textarea id="cmtInput" class="comment-input" placeholder="Vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n v·ªÅ phim n√†y..."></textarea>
                            <div class="form-actions">
                                <span style="font-size: 0.8rem; color: #666;">D√π g√°i hay trai, ch·ªâ hai l√† ƒë·ªß.</span>
                                <button class="btn-send-cmt" onclick="sendComment()">
                                    G·ª≠i <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="comment-list" id="commentList">
                        <div class="empty-comment">
                            <i class="fas fa-spinner fa-spin"></i>
                            ƒêang t·∫£i b√¨nh lu·∫≠n...
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-right">
                <div class="episode-block episode-block-desktop">
                    <div class="section-header">
                        <span>Danh s√°ch t·∫≠p</span>
                        <span class="server-name"><i class="fas fa-server"></i> Server VIP</span>
                    </div>
                    <div class="episode-grid" id="episodeListDesktop"></div>
                </div>

                <div class="section-header" style="border-left-color: #FF8F50; margin-bottom: 15px;">
                    <span style="font-size: 1.1rem;">ƒê·ªÅ xu·∫•t cho b·∫°n</span>
                </div>
                <div id="relatedList"></div>
            </div>

        </div>
    </div>

    <div class="ad-panel-wrapper">
        <a href="https://wibuphim.netlify.app" target="_blank" class="ad-link">
            <img src="https://wibuphim.netlify.app/WIBUPHIMADS.PNG" alt="Qu·∫£ng c√°o" class="ad-img-728">
        </a>
    </div>

<div class="community-section">
    <a href="https://www.facebook.com/groups/1165263735526384/" target="_blank" class="comm-card">
        <i class="fab fa-facebook comm-bg-deco"></i>
        
        <div class="comm-left">
            <div class="comm-icon">
                <i class="fab fa-facebook-f"></i>
            </div>
            <div class="comm-info">
                <div class="comm-title">C·ªông ƒê·ªìng WibuTeam</div>
                <div class="comm-desc">Tham gia Group Facebook ƒë·ªÉ y√™u c·∫ßu phim, b√°o l·ªói v√† ch√©m gi√≥ c√πng admin!</div>
            </div>
        </div>
        
        <div class="comm-btn">
            Tham Gia Ngay <i class="fas fa-arrow-right"></i>
        </div>
    </a>
</div>
    
 <footer>
    <div class="footer-grid">
        <div class="footer-col">
            <div class="footer-logo">
                <img src="/LOGO.WEBP" alt="WibuPhim">
                <span class="text-gradient brand-text">WIBUPHIM</span>
            </div>
            <p class="footer-desc">
                WibuPhim - N·ªÅn t·∫£ng xem phim tr·ª±c tuy·∫øn mi·ªÖn ph√≠ ch·∫•t l∆∞·ª£ng cao. C·∫≠p nh·∫≠t li√™n t·ª•c, kh√¥ng gi·∫≠t lag, tr·∫£i nghi·ªám ƒëi·ªán ·∫£nh ƒë·ªânh cao ngay t·∫°i nh√†.
            </p>
            <div class="footer-socials">
                <a href="https://www.facebook.com/wibuteam2026" class="social-link"><i class="fab fa-facebook-f"></i></a>
                <a href="https://www.facebook.com/wibuteam2026" class="social-link"><i class="fab fa-discord"></i></a>
                <a href="https://www.facebook.com/wibuteam2026" class="social-link"><i class="fab fa-tiktok"></i></a>
                <a href="https://www.facebook.com/wibuteam2026" class="social-link"><i class="fab fa-telegram-plane"></i></a>
            </div>
        </div>

        <div class="footer-col">
            <h4>Kh√°m Ph√°</h4>
            <ul class="footer-links">
                <li><a href="#" onclick="loadCategory('phim-moi', 'Phim M·ªõi')">Phim M·ªõi C·∫≠p Nh·∫≠t</a></li>
                <li><a href="#" onclick="loadCategory('phim-le', 'Phim L·∫ª')">Phim Chi·∫øu R·∫°p</a></li>
                <li><a href="#" onclick="loadCategory('phim-bo', 'Phim B·ªô')">Phim B·ªô ƒê·ªôc Quy·ªÅn</a></li>
                <li><a href="#" onclick="loadCategory('tv-shows', 'TV Shows')">TV Shows</a></li>
            </ul>
        </div>

        <div class="footer-col">
            <h4>H·ªó Tr·ª£</h4>
            <ul class="footer-links">
                <li><a href="../lienhequangcao.html">Li√™n h·ªá qu·∫£ng c√°o</a></li>
                <li><a href="../baoloi.html">B√°o l·ªói phim</a></li>
                <li><a href="../dieukhoan.html">ƒêi·ªÅu kho·∫£n d·ªãch v·ª•</a></li>
                <li><a href="https://wibuteam.netlify.app" target="_blank">V·ªÅ WibuTeam</a></li>
            </ul>
        </div>

        <div class="footer-col">
            <h4>T·∫£i ·ª®ng D·ª•ng</h4>
            <div class="download-group">
                <button class="btn-download-app">
                    <i class="fab fa-apple"></i>
                    <div class="btn-content">
                        <span class="btn-small-text">Download on the</span>
                        <span class="btn-big-text">App Store</span>
                    </div>
                </button>
                
                <button class="btn-download-app">
                    <i class="fab fa-google-play"></i>
                    <div class="btn-content">
                        <span class="btn-small-text">Get it on</span>
                        <span class="btn-big-text">Google Play</span>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <div class="footer-bottom">
        <span>&copy; 2026 WibuPhim. All Rights Reserved By WibuTeam.</span>
    </div>
</footer>

<script src="../chatbot.js"></script>
<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, setDoc, addDoc, collection, query, where, orderBy, onSnapshot, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // 1. CONFIG FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAT6SnKojUmsisDhnuEtsL3H59NwrhZxDc",
            authDomain: "hopphim-29e1c.firebaseapp.com",
            projectId: "hopphim-29e1c",
            storageBucket: "hopphim-29e1c.firebasestorage.app",
            messagingSenderId: "1076044580405",
            appId: "1:1076044580405:web:a3485f8533604f305e537c",
            measurementId: "G-6RT4CX2NR0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // üî• TH√äM D√íNG N√ÄY: Bi·∫øn to√†n c·ª•c ƒë·ªÉ check VIP si√™u nhanh
        window.isCurrentVip = false;

        // 2. CONSTANTS & UI ELEMENTS
        const API_BASE = 'https://ophim1.com/v1/api/phim';
        const IMG_BASE = 'https://img.ophim1.com/uploads/movies/';
        
        // UI Elements
        const loadingScreen = document.getElementById('loadingScreen');
        const btnLogin = document.getElementById('btnLogin');
        const userAvatar = document.getElementById('userAvatar');
        const userMenu = document.getElementById('userMenu');
        const mobileMemberBtn = document.getElementById('mobileMemberBtn');
        const mobileMemberText = document.getElementById('mobileMemberText');
        const cmtMyAvatar = document.getElementById('cmtMyAvatar');

        let currentUser = null;
        let player; 
        let currentMovieData = null; 
        let currentEpName = "T·∫≠p 1";

        // --- 3. PH√ÇN LO·∫†I NGU·ªíN PHIM (LOGIC QUAN TR·ªåNG) ---
        const urlParams = new URLSearchParams(window.location.search);
        
        // Ki·ªÉm tra xem c√≥ ph·∫£i phim Youtube Custom kh√¥ng?
        const isCustomYoutube = urlParams.get('custom') === 'youtube';
        const ytId = urlParams.get('id');
        const customName = urlParams.get('name');

        // L·∫•y Slug cho phim th∆∞·ªùng (Ophim)
        let movieSlug = urlParams.get('slug');
        if (!movieSlug && !isCustomYoutube) {
            const path = window.location.pathname;
            const parts = path.split('/').filter(part => part !== '');
            const lastPart = parts[parts.length - 1];
            // Lo·∫°i tr·ª´ c√°c file html ƒë·ªÉ kh√¥ng b·ªã nh·∫ßm
            if (lastPart && !lastPart.includes('.html')) {
                movieSlug = lastPart;
            }
        }

        // N·∫øu kh√¥ng ph·∫£i Youtube v√† c≈©ng kh√¥ng c√≥ Slug -> V·ªÅ trang ch·ªß
        if (!movieSlug && !isCustomYoutube) {
            alert('Kh√¥ng t√¨m th·∫•y phim!');
            window.location.href = '/'; 
        }

        // --- H√ÄM MUA G√ìI VIP ---
        window.buyVipPackage = async () => {
            if (!window.currentUser) {
                window.showToast("Vui l√≤ng ƒëƒÉng nh·∫≠p!", "error");
                return;
            }
            const confirmBuy = await window.customConfirm("Gia h·∫°n VIP 30 ng√†y v·ªõi 50 Coin?");
            if (!confirmBuy) return;

            const userRef = doc(db, "users", window.currentUser.uid);
            try {
                const snap = await getDoc(userRef);
                if (!snap.exists()) return;
                
                const data = snap.data();
                if ((data.coinBalance || 0) < 50) {
                    window.showToast("S·ªë d∆∞ kh√¥ng ƒë·ªß 50 Coin!", "error");
                    setTimeout(() => window.location.href = '/nap-coin.html', 1500);
                    return;
                }

                const thirtyDays = 2592000000;
                let newExpiration = Date.now() + thirtyDays;
                if (data.vipExpiration && data.vipExpiration > Date.now()) {
                    newExpiration = data.vipExpiration + thirtyDays;
                }

                await updateDoc(userRef, {
                    coinBalance: increment(-50),
                    vipExpiration: newExpiration
                });
                window.showToast("ƒê√£ mua VIP th√†nh c√¥ng!", "success");
            } catch (e) {
                console.error(e);
                window.showToast("L·ªói giao d·ªãch!", "error");
            }
        };

        // --- KHAI B√ÅO BI·∫æN TO√ÄN C·ª§C ƒê·ªÇ CHECK VIP C·ª∞C NHANH ---
        let isGlobalVip = false; // Bi·∫øn n√†y s·∫Ω l∆∞u tr·∫°ng th√°i VIP lu√¥n, kh√¥ng c·∫ßn fetch l·∫°i

        // --- BI·∫æN TO√ÄN C·ª§C ---
        window.isCurrentVip = false; 
        window.isMovieInitialized = false;

        // --- 3. QU·∫¢N L√ù TR·∫†NG TH√ÅI NG∆Ø·ªúI D√ôNG & QU·∫¢NG C√ÅO ---
        onAuthStateChanged(auth, async (user) => {
            // L·∫•y l·∫°i element
            const btnLogin = document.getElementById('btnLogin');
            const userAvatar = document.getElementById('userAvatar');
            const userNameDisplay = document.getElementById('userNameDisplay');
            const drawerLogout = document.getElementById('drawerLogout');
            const mobileMemberBtn = document.getElementById('mobileMemberBtn');
            const vipStatusLabel = document.getElementById('vipStatus');
            const cmtMyAvatar = document.getElementById('cmtMyAvatar');
            
            // Element Qu·∫£ng C√°o
            const adOverlay = document.getElementById('ad-overlay');
            const adPanels = document.querySelectorAll('.ad-panel-wrapper');

            // H√†m b·∫≠t qu·∫£ng c√°o (Ch·ªâ d√πng cho user th∆∞·ªùng)
            const activateAds = () => {
                if(adOverlay) adOverlay.style.display = 'flex';
                adPanels.forEach(p => p.style.display = 'flex');
            };

            if (user) {
                // === ƒê√É ƒêƒÇNG NH·∫¨P ===
                window.currentUser = user;
                currentUser = user;

                // Update UI c∆° b·∫£n
                if(btnLogin) btnLogin.style.display = 'none';
                if(userAvatar) { userAvatar.style.display = 'block'; userAvatar.src = user.photoURL || '/Guest.webp'; }
                if(cmtMyAvatar) cmtMyAvatar.src = user.photoURL || '/Guest.webp';
                if(drawerLogout) drawerLogout.style.display = 'flex';

                // üî• CHECK VIP T·ª™ FIRESTORE üî•
                try {
                    const snap = await getDoc(doc(db, "users", user.uid));
                    if (snap.exists()) {
                        const data = snap.data();
                        const vipExp = data.vipExpiration || 0;
                        window.isCurrentVip = vipExp > Date.now();
                        
                        // C·∫≠p nh·∫≠t UI Header (T√™n, Coin, Glow...)
                        updateHeaderUI(user, data, window.isCurrentVip);
                    }
                } catch(e) { console.log("L·ªói check VIP:", e); }

                // üî• QUY·∫æT ƒê·ªäNH QU·∫¢NG C√ÅO üî•
                if (window.isCurrentVip) {
                    console.log("üíé VIP: Gi·ªØ qu·∫£ng c√°o ·∫©n.");
                    // Kh√¥ng l√†m g√¨ c·∫£ v√¨ CSS ƒë√£ ·∫©n r·ªìi
                } else {
                    console.log("üë§ FREE: B·∫≠t qu·∫£ng c√°o.");
                    activateAds();
                }

            } else {
                // === KH√ÅCH (CH∆ØA ƒêƒÇNG NH·∫¨P) ===
                window.currentUser = null;
                currentUser = null;
                window.isCurrentVip = false;

                if(btnLogin) btnLogin.style.display = 'block';
                if(userAvatar) userAvatar.style.display = 'none';
                if(drawerLogout) drawerLogout.style.display = 'none';

                // Kh√°ch th√¨ b·∫≠t qu·∫£ng c√°o lu√¥n
                activateAds();
            }

            // üî• LOAD PHIM SAU KHI ƒê√É X·ª¨ L√ù XONG QU·∫¢NG C√ÅO üî•
            if (!window.isMovieInitialized) {
                loadMovie();
                window.isMovieInitialized = true;
            }
        });

        // H√†m ph·ª• tr·ª£ c·∫≠p nh·∫≠t Header (ƒê·ªÉ code tr√™n g·ªçn h∆°n)
        function updateHeaderUI(user, data, isVip) {
            const name = user.displayName || "Th√†nh vi√™n";
            const balance = data.coinBalance || 0;
            const userNameDisplay = document.getElementById('userNameDisplay');
            const userAvatar = document.getElementById('userAvatar');
            const vipStatusLabel = document.getElementById('vipStatus');
            const mobileMemberBtn = document.getElementById('mobileMemberBtn');

            if (isVip) {
                userAvatar.classList.add('vip-glow');
                userNameDisplay.innerHTML = `<span class="vip-name"><i class="fas fa-crown"></i> ${name}</span>`;
                const d = new Date(data.vipExpiration);
                vipStatusLabel.innerHTML = `<span style="color:#FFD700; font-weight:bold;"><i class="fas fa-gem"></i> VIP ƒë·∫øn: ${d.getDate()}/${d.getMonth()+1}</span>`;
            } else {
                userAvatar.classList.remove('vip-glow');
                userNameDisplay.innerText = name;
                vipStatusLabel.innerHTML = `<i class="fas fa-crown"></i> Free Plan`;
            }
            // Badge coin
            if(!userNameDisplay.innerHTML.includes('balance-badge')) {
                userNameDisplay.innerHTML += ` <span class="balance-badge"><i class="fas fa-coins"></i> ${balance.toLocaleString()}</span>`;
            }
            // Mobile Btn
            if(mobileMemberBtn) {
                 const nameHtmlMobile = isVip ? `<span class="vip-name">${name}</span>` : `<span>${name}</span>`;
                 mobileMemberBtn.innerHTML = `<img src="${user.photoURL||'/Guest.webp'}" style="width:30px;height:30px;border-radius:50%;border:2px solid #fff;" class="${isVip?'vip-glow':''}"> ${nameHtmlMobile}`;
                 mobileMemberBtn.onclick = () => window.location.href = '/profile.html';
            }
        }
        
        // 5. GLOBAL FUNCTIONS (Logout, Toast...)
        window.logout = async () => {
            const ok = await window.customConfirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?");
            if(ok) {
                await signOut(auth);
                window.showToast("ƒê√£ ƒëƒÉng xu·∫•t!", "success");
            }
        }
        window.toggleUserDropdown = () => document.getElementById('userMenu').classList.toggle('active');

        window.showToast = (msg, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            toast.innerHTML = `<i class="fas ${icon}"></i> <span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        window.customConfirm = (message) => {
            return new Promise((resolve) => {
                const overlay = document.getElementById('confirmModal');
                document.getElementById('confirmMsg').innerText = message;
                overlay.classList.add('active');
                document.getElementById('btnConfirmYes').onclick = () => { overlay.classList.remove('active'); resolve(true); };
                document.getElementById('btnConfirmNo').onclick = () => { overlay.classList.remove('active'); resolve(false); };
            });
        }

        // --- COMMENT LOGIC ---
        // --- G·ª¨I B√åNH LU·∫¨N (C√ì CHECK VIP) ---
        window.sendComment = async () => {
            if(!currentUser) return window.showToast("Vui l√≤ng ƒëƒÉng nh·∫≠p!", "error");
            
            const text = document.getElementById('cmtInput').value.trim();
            if(!text) return;

            // Check xem user hi·ªán t·∫°i c√≥ ph·∫£i VIP kh√¥ng
            const userRef = doc(db, "users", currentUser.uid);
            const userSnap = await getDoc(userRef);
            const isVip = userSnap.exists() && (userSnap.data().vipExpiration || 0) > Date.now();

            const currentMovieId = isCustomYoutube ? ('yt_' + ytId) : movieSlug;

            try {
                await addDoc(collection(db, "comments"), {
                    movieId: currentMovieId,
                    userId: currentUser.uid,
                    userName: currentUser.displayName || "Th√†nh vi√™n",
                    userAvatar: currentUser.photoURL || "/Guest.webp",
                    content: text,
                    isVip: isVip, // üî• L∆∞u tr·∫°ng th√°i VIP v√†o comment
                    timestamp: Date.now()
                });
                document.getElementById('cmtInput').value = '';
                window.showToast("ƒê√£ g·ª≠i b√¨nh lu·∫≠n!", "success");
            } catch(e) { window.showToast("L·ªói: " + e.message, "error"); }
        }

        // --- HI·ªÇN TH·ªä B√åNH LU·∫¨N (RENDER) ---
        const cId = isCustomYoutube ? ('yt_' + ytId) : movieSlug;
        if(cId) {
            const q = query(collection(db, "comments"), where("movieId", "==", cId), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('commentList');
                if(snapshot.empty) {
                    list.innerHTML = `<div class="empty-comment"><i class="fas fa-comment-slash"></i> Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</div>`;
                    return;
                }
                let html = '';
                snapshot.forEach(doc => {
                    const c = doc.data();
                    const timeAgo = timeSince(c.timestamp);
                    const badge = (c.userName === 'Admin') ? '<span class="badge-role">QTV</span>' : '';
                    
                    // üî• X·ª¨ L√ù STYLE VIP CHO B√åNH LU·∫¨N üî•
                    const vipClass = c.isVip ? 'is-vip' : '';
                    const avatarGlow = c.isVip ? 'vip-glow' : ''; // Th√™m h√†o quang cho avatar comment
                    const nameHtml = c.isVip 
                        ? `<span class="vip-name" style="font-size:0.95rem;"><i class="fas fa-crown"></i> ${c.userName}</span>` 
                        : `<span class="comment-author">${c.userName}</span>`;

                    html += `
                        <div class="comment-item ${vipClass}">
                            <img src="${c.userAvatar}" class="comment-avatar ${avatarGlow}">
                            <div class="comment-body">
                                <div class="comment-meta">${nameHtml} ${badge} <span class="comment-time">‚Ä¢ ${timeAgo}</span></div>
                                <div class="comment-text">${c.content}</div>
                            </div>
                        </div>`;
                });
                list.innerHTML = html;
            });
        }

        // --- H√ÄM KH·ªûI T·∫†O PLAYER (PLYR) ---
        function initPlayer(sourceType, sourceLink, poster = '', startTime = 0) {
            if (player) {
                player.destroy();
                player = null;
            }

            const container = document.getElementById('player-container');
            // T·∫°o l·∫°i th·∫ª video ƒë·ªÉ ƒë·∫£m b·∫£o tr√¨nh ph√°t lu√¥n s·∫°ch s·∫Ω, kh√¥ng b·ªã l·ªói ƒëen m√†n h√¨nh
            container.innerHTML = `<video id="player" playsinline controls data-poster="${poster}" style="width:100%;"></video>`;
            const videoElement = document.getElementById('player');

            const plyrOptions = {
                controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'],
                youtube: { noCookie: true, rel: 0, modestbranding: 1 }
            };

            if (sourceType === 'youtube') {
                player = new Plyr(videoElement, plyrOptions);
                player.source = { type: 'video', sources: [{ src: sourceLink, provider: 'youtube' }] };
                
                // Nh·∫£y ƒë·∫øn gi√¢y c≈© khi Youtube ƒë√£ s·∫µn s√†ng
                player.on('ready', () => { 
                    if (startTime > 0) player.currentTime = startTime; 
                });
            } 
            else if (sourceType === 'hls') {
                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(sourceLink);
                    hls.attachMedia(videoElement);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        player = new Plyr(videoElement, plyrOptions);
                        // Nh·∫£y ƒë·∫øn gi√¢y c≈© khi link m3u8 s·∫µn s√†ng
                        if (startTime > 0) player.currentTime = startTime;
                    });
                } else {
                    videoElement.src = sourceLink;
                    player = new Plyr(videoElement, plyrOptions);
                }
            }

            // --- B·ªò THEO D√ïI ƒê·ªÇ L∆ØU TI·∫æN TR√åNH ---
            // ƒê·ª£i 1 gi√¢y ƒë·ªÉ player ·ªïn ƒë·ªãnh r·ªìi m·ªõi g·∫Øn s·ª± ki·ªán
            setTimeout(() => {
                if (player) {
                    // 1. L∆∞u khi ng∆∞·ªùi d√πng b·∫•m T·∫°m d·ª´ng (Pause)
                    player.on('pause', () => {
                        const currentTime = Math.floor(player.currentTime);
                        window.saveToHistory(currentMovieData, currentEpName, currentTime);
                    });

                    // 2. C·ª© m·ªói 30 gi√¢y ƒëang xem th√¨ t·ª± l∆∞u m·ªôt l·∫ßn cho ch·∫Øc
                    setInterval(() => {
                        if (player && player.playing) {
                            const currentTime = Math.floor(player.currentTime);
                            window.saveToHistory(currentMovieData, currentEpName, currentTime);
                        }
                    }, 30000);
                }
            }, 1000);
        }

        /* ==============================================
           üî• FIX SEARCH LOGIC (T√åM KI·∫æM)
           ============================================== */
// --- LOGIC T√åM KI·∫æM ƒê·ªíNG B·ªò INDEX ---
let searchTimeout;
const IMG_BASE_URL = 'https://img.ophim1.com/uploads/movies/';

async function performSearch(keyword, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    if (!keyword || keyword.trim().length < 2) {
        container.innerHTML = '';
        container.classList.remove('active');
        return;
    }

    container.classList.add('active');
    container.innerHTML = '<div style="color:#aaa; padding:20px; text-align:center;"><i class="fas fa-spinner fa-spin"></i></div>';

    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(async () => {
        try {
            const res = await fetch(`https://ophim1.com/v1/api/tim-kiem?keyword=${encodeURIComponent(keyword)}`);
            const data = await res.json();

            if (data.data && data.data.items && data.data.items.length > 0) {
                let html = '';
                data.data.items.slice(0, 10).forEach(m => {
                    const img = m.thumb_url.startsWith('http') ? m.thumb_url : IMG_BASE_URL + m.thumb_url;
                    html += `
                        <div class="search-result-item" onclick="window.location.href='/xem-phim/${m.slug}'">
                            <img src="${img}" alt="${m.name}" loading="lazy">
                            <div class="search-result-info">
                                <div class="search-result-title">${m.name}</div>
                                <div class="search-result-meta">${m.year} ‚Ä¢ ${m.origin_name}</div>
                            </div>
                        </div>`;
                });
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div style="color:#666; padding:20px; text-align:center;">Kh√¥ng t√¨m th·∫•y phim n√†o...</div>';
            }
        } catch (e) {
            container.innerHTML = '<div style="color:#ff4757; padding:20px; text-align:center;">L·ªói k·∫øt n·ªëi server!</div>';
        }
    }, 500);
}

// G√°n s·ª± ki·ªán cho Desktop
const desktopSearch = document.getElementById('searchInput');
if(desktopSearch) {
    desktopSearch.addEventListener('input', (e) => performSearch(e.target.value, 'desktopSearchResults'));
}

// G√°n s·ª± ki·ªán cho Mobile
const mobileSearch = document.getElementById('mobileSearchInput');
if(mobileSearch) {
    mobileSearch.addEventListener('input', (e) => performSearch(e.target.value, 'mobileSearchResults'));
}

// Click ra ngo√†i ƒë·ªÉ ·∫©n k·∫øt qu·∫£ Desktop
document.addEventListener('click', (e) => {
    const box = document.querySelector('.search-box');
    const res = document.getElementById('desktopSearchResults');
    if (box && !box.contains(e.target) && res) {
        res.classList.remove('active');
    }
});

// H√†m m·ªü/ƒë√≥ng search mobile (D√πng chung cho to√†n web)
window.openMobileSearch = () => {
    document.getElementById('mobileSearchOverlay').classList.add('active');
    setTimeout(() => document.getElementById('mobileSearchInput').focus(), 300);
}
window.closeMobileSearch = () => {
    document.getElementById('mobileSearchOverlay').classList.remove('active');
}
        
        // 6. MAIN LOAD MOVIE LOGIC (ƒê√É T√ÅCH RA 2 TR∆Ø·ªúNG H·ª¢P)
// --- 6. H√ÄM LOAD PHIM CH√çNH (FULL LOGIC - D√ÅN ƒê√à C√ÅI C≈®) ---
        async function loadMovie() {
            // 1. L·∫•y th√¥ng tin t·ª´ URL
            const urlParams = new URLSearchParams(window.location.search);
            const isYT = urlParams.get('custom') === 'youtube';
            const ytId = urlParams.get('id');
            const customName = urlParams.get('name');
            const movieSlug = urlParams.get('slug') || window.location.pathname.split('/').pop().replace('.html', '');

            // T·∫°o ID duy nh·∫•t ƒë·ªÉ l∆∞u/l·∫•y l·ªãch s·ª≠
            const currentSlugId = isYT ? `?custom=youtube&id=${ytId}&name=${encodeURIComponent(customName)}` : movieSlug;

            let savedEpName = "T·∫≠p 1";
            let savedTime = 0;

            // 2. L·∫§Y L·ªäCH S·ª¨ XEM (RESUME) T·ª™ FIREBASE
            if (currentUser) {
                try {
                    const snap = await getDoc(doc(db, "users", currentUser.uid));
                    if (snap.exists() && snap.data().watchHistory) {
                        const history = snap.data().watchHistory;
                        // T√¨m phim trong l·ªãch s·ª≠
                        const oldData = history.find(m => decodeURIComponent(m.slug) === decodeURIComponent(currentSlugId));
                        
                        if (oldData) {
                            savedEpName = oldData.epName || "T·∫≠p 1";
                            savedTime = oldData.duration || 0;
                            console.log(`üî• Resume: ${savedEpName} t·∫°i gi√¢y ${savedTime}`);
                        }
                    }
                } catch (e) { console.error("L·ªói l·∫•y l·ªãch s·ª≠:", e); }
            }

            // --- TR∆Ø·ªúNG H·ª¢P A: PHIM YOUTUBE ---
            if (isYT && ytId) {
                const finalName = decodeURIComponent(customName || "Phim Youtube");
                const posterUrl = `https://img.youtube.com/vi/${ytId}/maxresdefault.jpg`;

                // T·∫°o object d·ªØ li·ªáu phim
                currentMovieData = {
                    slug: currentSlugId,
                    name: finalName,
                    thumb_url: `https://img.youtube.com/vi/${ytId}/hqdefault.jpg`,
                    poster_url: posterUrl
                };

                // Hi·ªÉn th·ªã th√¥ng tin phim gi·∫£ l·∫≠p
                const fakeInfo = {
                    name: finalName,
                    origin_name: 'YouTube Premium',
                    year: '2026',
                    quality: '4K',
                    lang: 'Vietsub',
                    content: 'Phim ƒë∆∞·ª£c ph√°t ƒë·ªôc quy·ªÅn tr√™n h·ªá th·ªëng WibuPhim. Ch√∫c b·∫°n xem phim vui v·∫ª!',
                    poster_url: posterUrl,
                    thumb_url: currentMovieData.thumb_url
                };
                renderInfo(fakeInfo);
                
                // ·∫®n block t·∫≠p phim v√¨ Youtube ch·ªâ c√≥ 1 video
                document.querySelectorAll('.episode-block').forEach(e => e.style.display = 'none');

                // G·ªçi h√†m ph√°t (K√®m th·ªùi gian ƒë√£ xem)
                window.changeEp(ytId, 'youtube', null, 'Full Video', savedTime);
                
                loadRelated(); // Load ƒë·ªÅ xu·∫•t
                hideLoadingState(); 
                return;
            }
            
            // --- TR∆Ø·ªúNG H·ª¢P B: PHIM T·ª™ OPHIM API ---
            if (!movieSlug) {
                hideLoadingState();
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/${movieSlug}`);
                const data = await res.json();

                if (data.status) {
                    const movie = data.data.item;

                    // N·∫øu ph√°t hi·ªán phim n√†y thu·ªôc th·ªÉ lo·∫°i Short Drama -> Chuy·ªÉn h∆∞·ªõng ngay
                    if (movie.category && movie.category.some(c => c.slug === 'short-drama')) {
                        console.log("Ph√°t hi·ªán Short Drama, ƒëang chuy·ªÉn h∆∞·ªõng...");
                        window.location.replace(`/short/${movie.slug}`); // D√πng replace ƒë·ªÉ kh√¥ng l∆∞u l·ªãch s·ª≠ l√πi l·∫°i
                        return; // D·ª´ng, kh√¥ng ch·∫°y code b√™n d∆∞·ªõi n·ªØa
                    }
                    
                    currentMovieData = movie; // L∆∞u l·∫°i global ƒë·ªÉ d√πng cho player
                    
                    renderInfo(movie);

                    // X·ª≠ l√Ω danh s√°ch t·∫≠p
                    const svData = movie.episodes[0].server_data;
                    let epHtml = ''; // Bi·∫øn ch·ª©a HTML danh s√°ch n√∫t t·∫≠p
                    
                    // Bi·∫øn t·∫°m ƒë·ªÉ x√°c ƒë·ªãnh t·∫≠p n√†o s·∫Ω ƒë∆∞·ª£c ph√°t
                    let targetEpToPlay = null; 
                    let targetIndex = 0;

                    svData.forEach((ep, idx) => {
                        const type = ep.link_m3u8 ? 'hls' : 'iframe';
                        const link = ep.link_m3u8 || ep.link_embed;
                        
                        // T·∫°o n√∫t t·∫≠p phim, g√°n ID ƒë·ªÉ sau n√†y active
                        epHtml += `<div class="ep-btn" id="btn-ep-${idx}" onclick="window.changeEp('${link}', '${type}', this, '${ep.name}')">${ep.name}</div>`;

                        // Logic t√¨m t·∫≠p ƒë·ªÉ ph√°t:
                        // N·∫øu t√™n t·∫≠p tr√πng v·ªõi l·ªãch s·ª≠ -> Ch·ªçn t·∫≠p n√†y
                        if (ep.name === savedEpName) {
                            targetEpToPlay = { link, type, name: ep.name };
                            targetIndex = idx;
                        }
                    });

                    // N·∫øu kh√¥ng t√¨m th·∫•y trong l·ªãch s·ª≠ (ho·∫∑c l·∫ßn ƒë·∫ßu xem), m·∫∑c ƒë·ªãnh ch·ªçn T·∫≠p 1 (index 0)
                    if (!targetEpToPlay && svData.length > 0) {
                        const firstEp = svData[0];
                        targetEpToPlay = { 
                            link: firstEp.link_m3u8 || firstEp.link_embed, 
                            type: firstEp.link_m3u8 ? 'hls' : 'iframe', 
                            name: firstEp.name 
                        };
                        targetIndex = 0;
                        savedTime = 0; // Reset time v√¨ l√† xem m·ªõi
                    }

                    // Render danh s√°ch n√∫t t·∫≠p ra m√†n h√¨nh
                    const mobileList = document.getElementById('episodeListMobile');
                    const desktopList = document.getElementById('episodeListDesktop');
                    if (mobileList) mobileList.innerHTML = epHtml;
                    if (desktopList) desktopList.innerHTML = epHtml;

                    // T·ª± ƒë·ªông ph√°t t·∫≠p ƒë√£ ch·ªçn
                    if (targetEpToPlay) {
                        // Highlight n√∫t ƒëang xem (c·∫£ tr√™n mobile v√† desktop)
                        setTimeout(() => {
                            const mobileBtn = document.querySelector(`#episodeListMobile #btn-ep-${targetIndex}`);
                            const desktopBtn = document.querySelector(`#episodeListDesktop #btn-ep-${targetIndex}`);
                            if (mobileBtn) mobileBtn.classList.add('active');
                            if (desktopBtn) desktopBtn.classList.add('active');
                        }, 100);

                        // G·ªçi h√†m ph√°t phim
                        window.changeEp(targetEpToPlay.link, targetEpToPlay.type, null, targetEpToPlay.name, savedTime);
                        
                        if(savedTime > 5) {
                            window.showToast(`ƒêang xem ti·∫øp ${targetEpToPlay.name}`, "success");
                        }
                    }

                    loadRelated();
                }
            } catch (e) {
                console.error("L·ªói t·∫£i phim:", e);
                window.showToast("L·ªói k·∫øt n·ªëi server phim!", "error");
            }
            
            hideLoadingState();
        }

        // H√†m h·ªó tr·ª£ t·∫Øt loading + Hi·ªán Chatbot
        function hideLoadingState() {
            setTimeout(() => {
                const screen = document.getElementById('loadingScreen');
                const img = screen?.querySelector('.loading-img');
                if(img) img.classList.add('zoom-out');
                
                setTimeout(() => { 
                    if(screen) screen.style.display = 'none'; 

                    // üî• K√çCH HO·∫†T CHATBOT SAU KHI LOAD XONG üî•
                    if (window.showChatbot) window.showChatbot();

                }, 480);
            }, 500);
        }

        // C√°c h√†m render ph·ª• tr·ª£ (Gi·ªØ nguy√™n c·ªßa OPhim)
        function renderInfo(movie) {
            document.title = `${movie.name} - WibuPhim`;
            document.getElementById('breadCrumbTitle').innerText = movie.name;
            document.getElementById('mName').innerText = movie.name;
            document.getElementById('mOrigin').innerText = `${movie.origin_name} (${movie.year})`;
            
            // --- 1. X·ª¨ L√ù R√öT G·ªåN N·ªòI DUNG (36 T·ª™) ---
            const contentBox = document.getElementById('mContent');
            const rawContent = movie.content || "ƒêang c·∫≠p nh·∫≠t n·ªôi dung...";
            
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = rawContent;
            const plainText = tempDiv.innerText || tempDiv.textContent;
            const words = plainText.trim().split(/\s+/);

            if (words.length > 36) {
                const shortContent = words.slice(0, 36).join(' ') + '...';
                contentBox.innerHTML = `
                    <span id="shortText">${shortContent}</span>
                    <span id="fullText" style="display: none;">${rawContent}</span>
                    <a href="javascript:void(0)" id="toggleBtn" onclick="window.toggleContent()" 
                    style="color: var(--primary-color); font-weight: 700; text-decoration: none; margin-left: 5px; cursor: pointer;">
                    Xem th√™m
                    </a>
                `;
            } else {
                contentBox.innerHTML = rawContent;
            }

            // --- 2. H√åNH N·ªÄN ---
            let bgImg = movie.poster_url || movie.thumb_url;
            if (!bgImg.startsWith('http')) bgImg = `https://img.ophim1.com/uploads/movies/${bgImg}`;
            document.getElementById('movieInfoBg').style.backgroundImage = `url('${bgImg}')`;

            // --- 3. HI·ªÇN TH·ªä TAGS (CH·∫§T L∆Ø·ª¢NG, NƒÇM, TH·ªÇ LO·∫†I, QU·ªêC GIA) ---
            let tagsHtml = `<span class="tag-item tag-highlight">${movie.quality || 'HD'}</span>`;
            tagsHtml += `<span class="tag-item">${movie.lang || 'Vietsub'}</span>`;
            tagsHtml += `<span class="tag-item">${movie.year}</span>`;
            
            // Hi·ªán Th·ªÉ lo·∫°i
            if (movie.category) {
                movie.category.forEach(cat => { tagsHtml += `<span class="tag-item">${cat.name}</span>`; });
            }
            
            // HI·ªÜN QU·ªêC GIA (D√≤ng n√†y m√¨nh ƒë√£ th√™m l·∫°i n√®!)
            if (movie.country && movie.country[0]) {
                tagsHtml += `<span class="tag-item"><i class="fas fa-globe"></i> ${movie.country[0].name}</span>`;
            }
            
            document.getElementById('mTags').innerHTML = tagsHtml;
            
            // L∆∞u l·ªãch s·ª≠
            setTimeout(() => { if (currentUser) saveToHistory(movie, currentEpName, Math.floor(player?.currentTime || 0)); }, 3000);
        }

        function renderEpisodes(episodes) {
            if (!episodes || episodes.length === 0) return;
            const svData = movie.episodes[0].server_data;
            let epHtml = ''; // üî• TH√äM D√íNG N√ÄY ƒê·ªÇ KH√îNG B·ªä L·ªñI
            svData.forEach((ep, idx) => {
                const link = ep.link_m3u8 || ep.link_embed;
                const type = ep.link_m3u8 ? 'hls' : 'iframe';
                const active = index === 0 ? 'active' : '';
                // Truy·ªÅn th√™m bi·∫øn 'type' v√†o h√†m
                html += `<div class="ep-btn ${active}" onclick="window.changeEp('${link}', '${type}', this)">${ep.name}</div>`;
            });
            
            document.getElementById('episodeListMobile').innerHTML = html;
            document.getElementById('episodeListDesktop').innerHTML = html;
        }

        // --- LOGIC ƒê·ªîI T·∫¨P (FIXED VIP CHECK) ---
        window.changeEp = async function(link, type, btn, epName = null, time = 0) {
            if (btn) {
                document.querySelectorAll('.ep-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                if(epName) currentEpName = epName;
                document.querySelector('.player-box')?.scrollIntoView({behavior: "smooth", block: "center"});
            }

            // D√πng bi·∫øn to√†n c·ª•c ƒë√£ check ·ªü b∆∞·ªõc 2
            if (window.isCurrentVip) {
                console.log("üíé VIP: B·ªè qua Preroll Ad");
                window.startActualPlayer(link, type, time);
            } else {
                console.log("üë§ FREE: Hi·ªán Preroll Ad");
                showPrerollAd(link, type, time);
            }
        }

        // --- QU·∫¢NG C√ÅO VIDEO (PREROLL) ---
        function showPrerollAd(link, type, time) {
            const container = document.getElementById('player-container');
            container.innerHTML = `
                <div class="preroll-container">
                    <img src="https://hopvan.netlify.app/IMG/hero-video.gif" class="preroll-gif">
                    <div class="preroll-info-box"><p>Qu·∫£ng c√°o</p><div>hopvan.netlify.app</div></div>
                    <div class="preroll-skip-area">
                        <button id="skip-ad-btn" class="btn-skip-preroll" disabled>B·ªè qua sau <span id="ad-timer" style="margin-left:5px;">5</span>s</button>
                    </div>
                </div>`;
            
            let timeLeft = 5;
            const timerText = document.getElementById('ad-timer');
            const skipBtn = document.getElementById('skip-ad-btn');
            
            const cd = setInterval(() => {
                timeLeft--;
                if(timerText) timerText.innerText = timeLeft;
                if(timeLeft <= 0) {
                    clearInterval(cd);
                    if(skipBtn) {
                        skipBtn.disabled = false;
                        skipBtn.classList.add('ready');
                        skipBtn.innerHTML = 'B·ªè qua qu·∫£ng c√°o <i class="fas fa-step-forward"></i>';
                        skipBtn.onclick = () => window.startActualPlayer(link, type, time);
                    }
                }
            }, 1000);
        }

        // --- H√ÄM PH√ÅT PLAYER TH·∫¨T ---
        window.startActualPlayer = function(link, type, startTime) {
            const container = document.getElementById('player-container');
            if (type === 'iframe') {
                container.innerHTML = `<div class="aspect-ratio-16-9"><iframe src="${link}" style="position:absolute; top:0; left:0; width:100%; height:100%; border:none;" allowfullscreen></iframe></div>`;
            } else {
                initPlayer(type, link, currentMovieData?.poster_url, startTime);
            }
        }
        
        // --- C·∫§U H√åNH ƒê·ªÄ XU·∫§T ---
        const MANUAL_RELATED = ["con-ra-the-thong-gi-nua-2026", "dia-nguc-doc-than-phan-5", "tieng-yeu-nay-anh-dich-duoc-khong", "duong-cung-ky-an-thanh-vu-phong-minh", "su-tro-lai-cua-tham-phan", "tuoi-tre-tai-cao", "con-say-mua-xuan", "trao-em-ca-vu-tru", "thu-hut-manh-liet", "truong-nguyet-tan-minh"];
        async function loadRelated() {
            try {
                const promises = MANUAL_RELATED.map(slug => fetch(`${API_BASE}/${slug}`));
                const results = await Promise.all(promises);
                const jsonResults = await Promise.all(results.map(res => res.json()));
                const validMovies = jsonResults.filter(d => d.status).map(d => d.data.item);

                if (validMovies.length > 0) {
                    let html = '';
                    validMovies.forEach(m => {
                        let img = m.thumb_url;
                        if (!img.startsWith('http')) img = `https://img.ophim1.com/uploads/movies/${img}`;
                        html += `
                            <div class="sidebar-card" onclick="window.location.href='/xem-phim/${m.slug}'">
                                <div class="sb-thumb"><img src="${img}" loading="lazy"></div>
                                <div class="sb-info">
                                    <div class="sb-title">${m.name}</div>
                                    <div class="sb-meta">${m.origin_name} (${m.year})</div>
                                    <div class="sb-views"><i class="fas fa-eye"></i> ${Math.floor(Math.random()*10000)}</div>
                                </div>
                            </div>`;
                    });
                    document.getElementById('relatedList').innerHTML = html;
                }
            } catch(e) {}
        }

        // H√†m b·∫≠t/t·∫Øt n·ªôi dung phim
        window.toggleContent = () => {
            const shortText = document.getElementById('shortText');
            const fullText = document.getElementById('fullText');
            const btn = document.getElementById('toggleBtn');
            
            // N·∫øu b·∫£n FULL ƒëang ·∫©n -> th√¨ HI·ªÜN b·∫£n FULL, ·∫®N b·∫£n NG·∫ÆN
            if (fullText.style.display === 'none') {
                fullText.style.display = 'inline';
                shortText.style.display = 'none';
                btn.innerHTML = 'Thu g·ªçn';
            } 
            // Ng∆∞·ª£c l·∫°i: HI·ªÜN b·∫£n NG·∫ÆN, ·∫®N b·∫£n FULL
            else {
                fullText.style.display = 'none';
                shortText.style.display = 'inline';
                btn.innerHTML = 'Xem th√™m';
            }
        };

        // Th√™m tham s·ªë poster v√†o h√†m
        window.saveToHistory = async (movie, epName = "T·∫≠p 1", duration = 0) => { 
            if (!window.currentUser || !movie) return;
            const ref = doc(db, "users", window.currentUser.uid);
            try {
                const snap = await getDoc(ref);
                let history = snap.exists() ? (snap.data().watchHistory || []) : [];
                
                // Chu·∫©n h√≥a Slug tr∆∞·ªõc khi l∆∞u/l·ªçc
                const currentSlug = decodeURIComponent(movie.slug);
                
                // Lo·∫°i b·ªè b·∫£n ghi c≈© c·ªßa phim n√†y
                history = history.filter(m => decodeURIComponent(m.slug) !== currentSlug);
                
                // Th√™m b·∫£n m·ªõi l√™n ƒë·∫ßu
                history.push({ 
                    slug: movie.slug, 
                    name: movie.name, 
                    thumb_url: movie.thumb_url,   
                    poster_url: movie.poster_url || movie.thumb_url, 
                    epName: epName,
                    duration: duration,
                    timestamp: Date.now() 
                });
                
                if (history.length > 20) history.shift();
                await setDoc(ref, { watchHistory: history }, { merge: true });
                console.log("ƒê√£ l∆∞u ti·∫øn tr√¨nh!");
            } catch (e) { console.error("L·ªói l∆∞u:", e); }
        };

        function loadHistory(uid) { /* Logic load history n·∫øu c·∫ßn hi·ªÉn th·ªã ·ªü ƒë√¢u ƒë√≥ */ }
        
        function timeSince(date) {
            if (!date) return "G·∫ßn ƒë√¢y";
            const seconds = Math.floor((Date.now() - date) / 1000);
            if (seconds < 60) return "V·ª´a xong";
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return minutes + " ph√∫t tr∆∞·ªõc";
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return hours + " gi·ªù tr∆∞·ªõc";
            return Math.floor(hours / 24) + " ng√†y tr∆∞·ªõc";
        }

    </script>
    
    <script>
        // C·∫§U H√åNH QU·∫¢NG C√ÅO GIF POPUP (B·ªé ƒê·∫æM GI·ªú)
        const adConfig = {
            gifUrl: "https://hopvan.netlify.app/IMG/hero-video.gif",
            targetUrl: "https://hopvan.netlify.app/"
        };

        const adOverlay = document.getElementById('ad-overlay');
        const adImage = document.getElementById('ad-image');
        const skipButton = document.getElementById('skip-button');
        const goToWebsiteButton = document.getElementById('go-to-website-button'); 

        if (adOverlay && skipButton && goToWebsiteButton && adImage) { 
            adImage.src = adConfig.gifUrl;
            
            // üî• M·ªû N√öT SKIP NGAY L·∫¨P T·ª®C
            skipButton.textContent = 'Skip ad'; 
            skipButton.classList.add('enabled');
            skipButton.removeAttribute('disabled'); 

            skipButton.addEventListener('click', (e) => {
                e.stopPropagation();
                closeAd();
            });

            goToWebsiteButton.addEventListener('click', (e) => {
                e.stopPropagation();
                openTarget();
            });

            adImage.addEventListener('click', () => {
                openTarget();
            });

            function openTarget() {
                window.open(adConfig.targetUrl, '_blank'); 
                closeAd();
            }

            function closeAd() {
                adOverlay.style.opacity = '0'; 
                setTimeout(() => { adOverlay.style.display = 'none'; }, 500);
            }
        }
    </script>

<script src="../backtotop.js"></script>
</body>
</html>